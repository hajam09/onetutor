{% extends "accounts/account_base.html" %}
{% load static %}
{% block content %}
<style type="text/css">
	.ui-w-80{width:100px!important;height:auto}
	#buttons_in_footer{display: none;}
	.pagination>li>a { border-radius: 50% !important;margin: 0 5px;}
	@media (min-width: 1200px) {
		.container {
			width: 1600px;
		}
		.wrapper {
			width: 75%;
		}
	}

	@media (min-width: 972px) and (max-width: 1200px) {
		.container {
			width: 1600px;
		}
		.wrapper {
			width: 90%;
		}
	}

	@media (min-width: 700px) and (max-width: 959px) {
		.container {
			width: 1600px;
		}
		.wrapper {
			width: 90%;
		}
	}

	@media (max-width: 767px) {
		#buttons_in_sidebar{display:none;}
		#buttons_in_footer{display:inline;}
	}
</style>
<div>
	{% if community.community_banner %}
	<img src="{{ community.community_banner.url }}" class="img-fluid mx-auto d-block" alt="Responsive image">
	{% else %}
	<div id="random_banner_colour" class="p-3 mb-2 text-white" style="height:180px;">
		<div class="container" style="padding-top: 110px;">
			<div class="row">
				<div class="col-3 col-md-auto">
					<img src="https://icon-library.com/images/default-user-icon/default-user-icon-13.jpg" alt="" class="d-block ui-w-80 rounded-circle">
				</div>
				<div class="col-9">
					<h2 style="padding-top: 17px;" id="community_title">{{community.community_title}}</h2>
					<div id="join_leave_community">
						{% if in_community %}
						<button type="button" class="btn btn-danger" style="border-radius: 16px;padding: 5px 40px;" onclick="leaveCommunity();">Leave</button>
						{% else %}
						<button type="button" class="btn btn-primary" style="border-radius: 16px;padding: 5px 40px;" onclick="joinCommunity();">Join</button>
						{% endif %}
						<button type="button" class="btn btn-primary" style="border-radius: 16px;padding: 5px 40px;" data-toggle="modal" data-target="#newForumThread">Start a Forum</button>
					</div>
					<div>
						<div class="modal fade" id="newForumThread" tabindex="-1" role="dialog" aria-labelledby="threadModalLabel" aria-hidden="true">
							<div class="modal-dialog modal-lg" role="document">
								<div class="modal-content">
									<form method="post" enctype="multipart/form-data">
										{% csrf_token %}
										<input type="name" name="create_forum" hidden>
										<div class="modal-header d-flex align-items-center bg-primary text-white">
											<h6 class="modal-title mb-0" id="threadModalLabel">New Forum</h6>
											<button type="button" class="close" data-dismiss="modal" aria-label="Close">
											<span aria-hidden="true">×</span>
											</button>
										</div>
										<div class="modal-body">
											<div class="form-group">
												<input type="text" class="form-control" placeholder="Forum Title" name="forum_title" required>
											</div>
											<div class="form-group">
												<textarea class="form-control summernote" id="description" name="description" placeholder="Enter something..." rows="5" autofocus=""></textarea>
											</div>
											<div class="custom-file form-control-sm mt-3" style="max-width: 300px;">
												<input type="file" class="custom-file-input" id="forum_image" name="forum_image" />
												<label class="custom-file-label" for="forum_image">Attachment</label>
											</div>
										</div>
										<div class="modal-footer">
											<button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
											<button type="submit" class="btn btn-primary">Create</button>
										</div>
									</form>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	{% endif %}
</div>
<div class="wrapper" style="margin: auto;overflow-x: hidden; color: black;">
	<div class="gutters-sm">
		<div style="height:70px;"></div>
		<div class="col-md-12">
			<div class="row">
				<div class="col-12 col-md-8" id="list_of_forums">
					<!-- Forum div here... -->
					{% if not forums %}
					<div class="alert alert-info " role="alert" style="text-align: center;"> This forum is empty. Why don't you start one. </div>
					{% endif %}
				</div>
				<div class="col">
					<div class="card card-header bg-secondary text-white">About this Community</div>
					<div class="card card-body">
						<div class="row">
							<div class="col-12">
								<div class="row">
									<div class="col">{{community.community_description}}</div>
								</div>
							</div>
						</div>
						</div>
					<div class="col-xs-12" style="height:30px;"></div>
				</div>
			</div>
		</div>
	</div>
	<div class="d-flex justify-content-center">
		<nav aria-label="Page navigation example">
			<ul class="pagination">
				<li class="page-item" id="previous_page">
					<a class="page-link" href="{% url 'forum:communitypage' community.pk current_page|add:'-1' %}" aria-label="Previous">
					<span aria-hidden="true">«</span>
					<span class="sr-only">Previous</span>
					</a> 
				</li>
				<li class="page-item" id="next_page">
					<a class="page-link" href="{% url 'forum:communitypage' community.pk current_page|add:'1' %}" aria-label="Next">
						<span aria-hidden="true">»</span>
						<span class="sr-only">Next</span>
					</a>
				</li>
			</ul>
		</nav>
	</div>
</div>
<script type="text/javascript">
	var random_banner_colours = ['bg-primary', 'bg-secondary', 'bg-success', 'bg-danger', 'bg-warning', 'bg-info' ]
	$( "div#random_banner_colour" ).addClass( random_banner_colours[1] );

	function joinCommunity() {
		$.ajax({
			data: {
				'functionality': 'join_community'
			},
			dataType: 'json',
			success: function (response) {
				if (response.status_code == 200) {
					$('#join_leave_community').find('button').first().remove();
					$("#join_leave_community").prepend('<button type="button" class="btn btn-danger" style="border-radius: 16px;padding: 5px 40px;" onclick="leaveCommunity();">Leave</button>');
				} else if (response.status_code == 401) {
					Swal.fire({
						icon: 'warning',
						title: "Can't do that!",
						text: response.message
					});
				}
			}
		});
	}

	function leaveCommunity() {
		$.ajax({
			data: {
				'functionality': 'leave_community'
			},
			dataType: 'json',
			success: function (response) {
				if (response.status_code == 200) {
					$('#join_leave_community').find('button').first().remove();
					$("#join_leave_community").prepend('<button type="button" class="btn btn-primary" style="border-radius: 16px;padding: 5px 40px;" onclick="joinCommunity();">Join</button>');
				}
			}
		});
	}

	$(document).ready(function () {
		display_forums();
		display_pagination();
	});

	function display_forums() {
		{% for f in forums %}

		var forum_div_container = `
		<div class="row border border-secondary">
			<div class="col-md-auto text-center border-right border-primary" style="padding-bottom: 10px; padding-top: 10px;" id="buttons_in_sidebar">
				<button type="button" class="btn btn-success" onclick="upvote_forum('{{f.id}}');"><i class='far fa-thumbs-up' style='font-size:15px'></i></button><br>
				<span class='forum_vote_{{f.id}}'>{{f.forum_likes.count}}</span>
				<br><button type="button" class="btn btn-danger" onclick="downvote_forum('{{f.id}}');"><i class='far fa-thumbs-down' style='font-size:15px'></i></button>
			</div>
			<div class="col" style="padding-bottom: 10px; padding-top: 10px;">
				<div style="max-height: 500px;text-overflow: ellipsis;overflow: hidden;">
					<span class="text-secondary">Post by {{f.creator.get_full_name}} at {{f.created_at}}</span>
					<h3>{{f.forum_title}}</h3>
					{% if f.forum_image %}
					<img class="mx-auto d-block" src="{{ f.forum_image.url }}" style="max-width:100%;max-height:420px;">
					<!-- change max-height to auto if problem persists -->
					{% else %}
					<p>{{f.forum_description|linebreaksbr}}</p>
					{% endif %}
				</div>
				<div>
					<a href="#"><i class='far fa-comment-alt' style='font-size:15px'></i> {{f.forumcomment_set.all|length}} Comments</a>
					&nbsp;&nbsp;
					<a href="#"><i class='fas fa-share' style='font-size:15px'></i> Share</a>
					&nbsp;&nbsp;
					<a href="#"><i class='fas fa-flag' style='font-size:15px'></i> Report</a>
					&nbsp;&nbsp;
					<span id="buttons_in_footer">
						<button type="button" class="btn btn-success" style="padding: 2px 2px;" onclick="upvote_forum('{{f.id}}');"><i class='far fa-thumbs-up' style='font-size:15px;'></i></button>
						<span class='forum_vote_{{f.id}}'>{{f.forum_likes.count}}</span>
						<button type="button" class="btn btn-danger" style="padding: 2px 2px;" onclick="downvote_forum('{{f.id}}');"><i class='far fa-thumbs-down' style='font-size:15px;'></i></button>
					</span>
				</div>
			</div>
		</div>
		<div style="height:20px;"></div>`;

		$('#list_of_forums').append(forum_div_container);

		{% endfor %}
	}

	function upvote_forum(forum_id) {
		$.ajax({
			data: {
				'functionality': 'upvote_forum',
				'forum_id': forum_id
			},
			dataType: 'json',
			success: function (response) {
				if(response.status_code == 200) {
					var this_forum = eval(response.this_forum)[0];
					var number_of_likes = this_forum.fields.forum_likes.length;
					var number_of_dislikes = this_forum.fields.forum_dislikes.length;

					$('.forum_vote_'+forum_id).text(number_of_likes-number_of_dislikes);

				} else if (response.status_code == 401) {
	            	Swal.fire({
	            		icon: 'warning',
	            		title: "Can't do that!",
	            		text: response.message
	            	});

	            } else if (response.status_code == 404) {
	            	Swal.fire({
	            		icon: 'error',
	            		title: "Can't do that!",
	            		text: response.message
	            	});
	            	// TODO: Remove the forum div.
	            	// $( ".question_answer_comment_container_"+commentId ).remove();
	            }
			}
		});
	}

	function downvote_forum(forum_id) {
		$.ajax({
			data: {
				'functionality': 'downvote_forum',
				'forum_id': forum_id
			},
			dataType: 'json',
			success: function (response) {
				if(response.status_code == 200) {
					var this_forum = eval(response.this_forum)[0];
					var number_of_likes = this_forum.fields.forum_likes.length;
					var number_of_dislikes = this_forum.fields.forum_dislikes.length;

					$('.forum_vote_'+forum_id).text(number_of_likes-number_of_dislikes);

				} else if (response.status_code == 401) {
	            	Swal.fire({
	            		icon: 'warning',
	            		title: "Can't do that!",
	            		text: response.message
	            	});

	            } else if (response.status_code == 404) {
	            	Swal.fire({
	            		icon: 'error',
	            		title: "Can't do that!",
	            		text: response.message
	            	});
	            	// TODO: Remove the forum div.
	            	// $( ".question_answer_comment_container_"+commentId ).remove();
	            }
			}
		});
	}

	function generatePagination(currentPage, lastPage) {
		const delta = 3;
		const range = [];

		for (let i = Math.max(2, (currentPage - delta)); i <= Math.min((lastPage - 1), (currentPage + delta)); i += 1) {
			range.push(i);
		}

		if ((currentPage - delta) > 2) {
			range.unshift('...');
		}

		if ((currentPage + delta) < (lastPage - 1)) {
			range.push('...');
		}

		range.unshift(1);
		if (lastPage !== 1)
			range.push(lastPage);
		return range;
	}

	function display_pagination() {
		var list_of_pages = generatePagination(parseInt("{{current_page}}"), parseInt("{{last_page}}"));
		console.log(list_of_pages);
		
		for (let i = 0; i<list_of_pages.length; i++) {
			var new_tag = null;
			var index = null;
			var href_url = null;

			if ( list_of_pages[i] == '...' ) {
				index = '#';
				href_url = '#';
			}
			else {
				index = list_of_pages[i];
				href_url = '/forum/c/{{community.pk}}/'+index+'/';
			}

			if (list_of_pages[i] == {{current_page}}) {
				new_tag = '<li class="page-item active"><a class="page-link" href="'+href_url+'">'+list_of_pages[i]+'</a></li>';
			} else {
				if ( list_of_pages[i] != '...' )
					new_tag = '<li class="page-item"><a class="page-link" href="'+href_url+'">'+list_of_pages[i]+'</a></li>';
				else
					new_tag = '<li class="page-item"><a class="page-link" href="'+href_url+'" onclick="return false;">'+list_of_pages[i]+'</a></li>';
			}
			$( new_tag ).insertBefore( "#next_page" );
		}
	}
</script>
{% endblock %}