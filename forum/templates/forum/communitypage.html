{% extends "accounts/account_base.html" %}
{% load static %}
{% block content %}
<style type="text/css">
	.ui-w-80{width:100px!important;height:auto}
	#buttons_in_footer{display: none;}
	@media (min-width: 1200px) {
		.container {
			width: 1600px;
		}
		.wrapper {
			width: 75%;
		}
	}

	@media (min-width: 972px) and (max-width: 1200px) {
		.container {
			width: 1600px;
		}
		.wrapper {
			width: 90%;
		}
	}

	@media (min-width: 700px) and (max-width: 959px) {
		.container {
			width: 1600px;
		}
		.wrapper {
			width: 90%;
		}
	}

	@media (max-width: 767px) {
		#buttons_in_sidebar{display:none;}
		#buttons_in_footer{display:inline;}
	}
</style>
<div>
	{% if community.community_banner %}
	<img src="{{ community.community_banner.url }}" class="img-fluid mx-auto d-block" alt="Responsive image">
	{% else %}
	<div id="random_banner_colour" class="p-3 mb-2 text-white" style="height:180px;">
		<div class="container" style="padding-top: 110px;">
			<div class="row">
				<div class="col-3 col-md-auto">
					<img src="https://icon-library.com/images/default-user-icon/default-user-icon-13.jpg" alt="" class="d-block ui-w-80 rounded-circle">
				</div>
				<div class="col-9">
					<h2 style="padding-top: 17px;" id="community_title">{{community.community_title}}</h2>
					<div id="join_leave_community">
						{% if in_community %}
						<button type="button" class="btn btn-danger" style="border-radius: 16px;padding: 5px 40px;" onclick="leaveCommunity();">Leave</button>
						{% else %}
						<button type="button" class="btn btn-primary" style="border-radius: 16px;padding: 5px 40px;" onclick="joinCommunity();">Join</button>
						{% endif %}
						<button type="button" class="btn btn-primary" style="border-radius: 16px;padding: 5px 40px;" data-toggle="modal" data-target="#newForumThread">Start a Forum</button>
					</div>
					<div>
						<div class="modal fade" id="newForumThread" tabindex="-1" role="dialog" aria-labelledby="threadModalLabel" aria-hidden="true">
							<div class="modal-dialog modal-lg" role="document">
								<div class="modal-content">
									<form method="post" enctype="multipart/form-data">
										{% csrf_token %}
										<input type="name" name="create_forum" hidden>
										<div class="modal-header d-flex align-items-center bg-primary text-white">
											<h6 class="modal-title mb-0" id="threadModalLabel">New Forum</h6>
											<button type="button" class="close" data-dismiss="modal" aria-label="Close">
											<span aria-hidden="true">Ã—</span>
											</button>
										</div>
										<div class="modal-body">
											<div class="form-group">
												<input type="text" class="form-control" placeholder="Forum Title" name="forum_title" required>
											</div>
											<div class="form-group">
												<textarea class="form-control summernote" id="description" name="description" placeholder="Enter something..." rows="5" autofocus=""></textarea>
											</div>
											<div class="custom-file form-control-sm mt-3" style="max-width: 300px;">
												<input type="file" class="custom-file-input" id="forum_image" name="forum_image" />
												<label class="custom-file-label" for="forum_image">Attachment</label>
											</div>
										</div>
										<div class="modal-footer">
											<button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
											<button type="submit" class="btn btn-primary">Create</button>
										</div>
									</form>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	{% endif %}
</div>
<div class="wrapper" style="margin: auto;overflow-x: hidden; color: black;">
	<div class="gutters-sm">
		<div style="height:70px;"></div>
		<div class="col-md-12">
			<div class="row">
				<div class="col-12 col-md-8" id="list_of_forums">
					<!-- Forum div here... -->
					{% if not forums %}
					<div class="alert alert-info " role="alert" style="text-align: center;"> This forum is empty. Why don't you start one. </div>
					{% endif %}
				</div>
				<div class="col">
					<div class="card card-header bg-secondary text-white">About this Community</div>
					<div class="card card-body">
						<div class="row">
							<div class="col-12">
								<div class="row">
									<div class="col">{{community.community_description}}</div>
								</div>
								<div class="col-xs-12" style="height:15px;"></div>
								<div class="row">
									<div class="col" id="community_members">
										<br><p style="font-size: 14px; font-weight: 500; line-height: 16px; display: inline-block; word-break: break-word;">Member(s)</p>
									</div>
									<div class="col">0
										<br><p style="font-size: 14px; font-weight: 500; line-height: 16px; display: inline-block; word-break: break-word;">Online</p></div>
								</div>
								<div class="row">
									<div class="col"><hr></div>
								</div>
								<div class="row">
									<div class="col">Created at {{community.created_at}}</div>
								</div>
							</div>
						</div>
						</div>
					<div class="col-xs-12" style="height:30px;"></div>
				</div>
			</div>
		</div>
	</div>
	
</div>
<script type="text/javascript">
	var random_banner_colours = ['bg-primary', 'bg-secondary', 'bg-success', 'bg-danger', 'bg-warning', 'bg-info' ]
	$( "div#random_banner_colour" ).addClass( random_banner_colours[1] );

	function joinCommunity() {
		$.ajax({
			data: {
				'functionality': 'join_community'
			},
			dataType: 'json',
			success: function (response) {
				if (response.status_code == 200) {
					$('#join_leave_community').find('button').first().remove();
					$("#join_leave_community").prepend('<button type="button" class="btn btn-danger" style="border-radius: 16px;padding: 5px 40px;" onclick="leaveCommunity();">Leave</button>');
				} else if (response.status_code == 401) {
					Swal.fire({
						icon: 'warning',
						title: "Can't do that!",
						text: response.message
					});
				}
			}
		});
	}

	function leaveCommunity() {
		$.ajax({
			data: {
				'functionality': 'leave_community'
			},
			dataType: 'json',
			success: function (response) {
				if (response.status_code == 200) {
					$('#join_leave_community').find('button').first().remove();
					$("#join_leave_community").prepend('<button type="button" class="btn btn-primary" style="border-radius: 16px;padding: 5px 40px;" onclick="joinCommunity();">Join</button>');
				}
			}
		});
	}

	$(document).ready(function () {
		display_forums();
		update_community_info();
	});

	function display_forums() {
		{% for f in forums %}
		var forumVotes = '{{f.forum_likes.count}}' - '{{f.forum_dislikes.count}}';
		var forumDescription = '{{f.forum_description|linebreaksbr}}'.replace(/\n\r?/g, '<br />');
		display_forum_container('{{f.id}}', forumVotes, '{{f.creator.get_full_name}}', '{{f.created_at}}', '{{f.forum_title}}', forumDescription, '{{f.forumcomment_set.all|length}}', '{{ f.forum_image }}')
		{% endfor %}
	}

	function upvote_forum(forum_id) {
		$.ajax({
			data: {
				'functionality': 'upvote_forum',
				'forum_id': forum_id
			},
			dataType: 'json',
			success: function (response) {
				if(response.status_code == 200) {
					var this_forum = eval(response.this_forum)[0];
					var number_of_likes = this_forum.fields.forum_likes.length;
					var number_of_dislikes = this_forum.fields.forum_dislikes.length;

					$('.forum_vote_'+forum_id).text(number_of_likes-number_of_dislikes);

				} else if (response.status_code == 401) {
	            	Swal.fire({
	            		icon: 'warning',
	            		title: "Can't do that!",
	            		text: response.message
	            	});

	            } else if (response.status_code == 404) {
	            	Swal.fire({
	            		icon: 'error',
	            		title: "Can't do that!",
	            		text: response.message
	            	});
	            	// TODO: Remove the forum div.
	            	// $( ".question_answer_comment_container_"+commentId ).remove();
	            }
			}
		});
	}

	function downvote_forum(forum_id) {
		$.ajax({
			data: {
				'functionality': 'downvote_forum',
				'forum_id': forum_id
			},
			dataType: 'json',
			success: function (response) {
				if(response.status_code == 200) {
					var this_forum = eval(response.this_forum)[0];
					var number_of_likes = this_forum.fields.forum_likes.length;
					var number_of_dislikes = this_forum.fields.forum_dislikes.length;

					$('.forum_vote_'+forum_id).text(number_of_likes-number_of_dislikes);

				} else if (response.status_code == 401) {
	            	Swal.fire({
	            		icon: 'warning',
	            		title: "Can't do that!",
	            		text: response.message
	            	});

	            } else if (response.status_code == 404) {
	            	Swal.fire({
	            		icon: 'error',
	            		title: "Can't do that!",
	            		text: response.message
	            	});
	            	// TODO: Remove the forum div.
	            	// $( ".question_answer_comment_container_"+commentId ).remove();
	            }
			}
		});
	}

	var NEXT_INDEX = 1;

	window.onscroll = function(ev) {
		if ((window.innerHeight + window.pageYOffset) >= document.body.offsetHeight) {
			
			$.ajax({
				data: {
					'functionality': 'fetch_forums',
					'next_index': NEXT_INDEX
				},
				dataType: 'json',
				success: function (response) {
					if(response.status_code == 200) {

						var this_forum = response.forum_json;

						for (var i = 0; i<this_forum.length; i++) {
							display_forum_container(this_forum[i].forumId, this_forum[i].forumVotes, this_forum[i].forumCreatorFullName,  this_forum[i].forumCreatedDate, this_forum[i].forumTitle, this_forum[i].forumDescription, this_forum[i].forumCommentCount, this_forum[i].forumImage);
						}

						NEXT_INDEX = NEXT_INDEX + 1;
					}
				}
			});
		}
	};

	function display_forum_container(forumId, forumVotes, forumCreatorFullName, forumCreatedDate, forumTitle, forumDescription, forumCommentCount, forumImage) {
		var image_tab = null;
		forumDescription = forumDescription.replace(/\n/g, '<br>\n');
		if (forumImage) {
			image_tab = '<img class="mx-auto d-block" src="../../../media/'+forumImage+'" style="max-width:100%;max-height:420px;">';
		} else {
			image_tab = '<p>'+forumDescription+'</p>';
		}
		

		var forum_div_container = `
		<div class="row border border-secondary" id="container_`+forumId+`">
			<div class="col-md-auto text-center border-right border-primary" style="padding-bottom: 10px; padding-top: 10px;" id="buttons_in_sidebar">
				<button type="button" class="btn btn-success" onclick="upvote_forum('`+forumId+`');"><i class='far fa-thumbs-up' style='font-size:15px'></i></button><br>
				<span class='forum_vote_`+forumId+`'>`+forumVotes+`</span>
				<br><button type="button" class="btn btn-danger" onclick="downvote_forum('`+forumId+`');"><i class='far fa-thumbs-down' style='font-size:15px'></i></button>
			</div>
			<div class="col" style="padding-bottom: 10px; padding-top: 10px;">
				<div style="max-height: 500px;text-overflow: ellipsis;overflow: hidden;">
					<span class="text-secondary">Post by `+forumCreatorFullName+` at `+forumCreatedDate+`</span>
					<h3>`+forumTitle+`</h3>
					`+image_tab+`
				</div>
				<div>
					<a href="#"><i class='far fa-comment-alt' style='font-size:15px'></i> `+forumCommentCount+` Comments</a>
					&nbsp;&nbsp;
					<a href="#"><i class='fas fa-share' style='font-size:15px'></i> Share</a>
					&nbsp;&nbsp;
					<a href="#"><i class='fas fa-flag' style='font-size:15px'></i> Report</a>
					&nbsp;&nbsp;
					<span id="buttons_in_footer">
						<button type="button" class="btn btn-success" style="padding: 2px 2px;" onclick="upvote_forum('`+forumId+`');"><i class='far fa-thumbs-up' style='font-size:15px;'></i></button>
						<span class='forum_vote_`+forumId+`'>`+forumVotes+`</span>
						<button type="button" class="btn btn-danger" style="padding: 2px 2px;" onclick="downvote_forum('`+forumId+`');"><i class='far fa-thumbs-down' style='font-size:15px;'></i></button>
					</span>
				</div>
			</div>
		</div>
		<div style="height:20px;"></div>`;

		$('#list_of_forums').append(forum_div_container);
	}

	function update_community_info() {
		var member_count = parseInt('{{community.community_members.all|length}}');
		$('#community_members').prepend(intCompromise(member_count));
	}

	function intCompromise(value) {
		var suffixes = ["", "k", "m", "b","t"];
		var suffixNum = Math.floor((""+value).length/3);
		var shortValue = parseFloat((suffixNum != 0 ? (value / Math.pow(1000,suffixNum)) : value).toPrecision(2));

		if (shortValue % 1 != 0)
			shortValue = shortValue.toFixed(1);

		return shortValue+suffixes[suffixNum];
	}
	
</script>
{% endblock %}