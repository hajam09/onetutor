{% extends "accounts/account_base.html" %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
<style type="text/css">
.card-header .title {
	font-size: 17px;
}

.card-header .accicon {
	float: right;
	font-size: 20px;
	wiph: 1.2em;
}

.card-header {
	cursor: pointer;
	border-bottom: none;
}

.card-header:not(.collapsed) .rotate-icon { transform: rotate(180deg);}

.avatars {
    padding-left: 0;
    list-style: none;
    margin: 0;
}

.avatars>li {
    display: inline-block;
}

.avatars>li+li {
    margin-left: -0.75rem;
}

.avatar {
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 50%;
    border: 2px solid #f8f9fa;
    background: #f8f9fa;
    color: #fff;
}

</style>
<div class="container-fluid" style="margin: auto;overflow-x: hipen; max-width: 1500px;color: black;">
    <br>
    <div class="row gutters-sm">
        <div class="col-12 col-md-12 col-lg-8 col-xl-8">
            {% block ticketContent %}
            {% endblock %}
        </div>
        <div class="col-12 col-md-12 col-lg-4 col-xl-4 d-none d-lg-block d-xl-none d-none d-xl-block">
            <div id="ticketDetails">
                <div class="card" style="color: black;">
                    <div class="card-header" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true">     
                        <span class="title">Details </span>
                        <span class="accicon"><i class="fas fa-angle-down rotate-icon"></i></span>
                    </div>
                    <div id="collapseOne" class="collapse show" data-parent="#ticketDetails">
                        <div class="card-body">
                        	<dl class="row">
							    <p class="col-lg-4 col-md-6 col-sm-6"><small>Assignee</small></p>
							    <p class="col-lg-8 col-md-6 col-sm-6">#</p>

							    <p class="col-lg-4 col-md-6 col-sm-6"><small>Reporter</small></p>
							    <p class="col-lg-8 col-md-6 col-sm-6">
                                    <img src="{{ ticket.reporter.developerProfile.profilePicture.url }}" width="30px" class="rounded-0">&nbsp;
                                    <a href="{{ p.getProjectUrl }}">{{ ticket.reporter.get_full_name }}</a>                     
                                </p>

							    <p class="col-lg-4 col-md-6 col-sm-6"><small>Components</small></p>
							    <p class="col-lg-8 col-md-6 col-sm-6">#</p>

							    <p class="col-lg-4 col-md-6 col-sm-6"><small>Fix Versions</small></p>
							    <p class="col-lg-8 col-md-6 col-sm-6">#</p>

							    <p class="col-lg-4 col-md-6 col-sm-6"><small>Labels</small></p>
							    <p class="col-lg-8 col-md-6 col-sm-6">#</p>

							    <p class="col-lg-4 col-md-6 col-sm-6"><small>Story Points</small></p>
							    <p class="col-lg-8 col-md-6 col-sm-6">#</p>

							    <p class="col-lg-4 col-md-6 col-sm-6"><small>Man days</small></p>
							    <p class="col-lg-8 col-md-6 col-sm-6">#</p>

							    <p class="col-lg-4 col-md-6 col-sm-6"><small>Sprint</small></p>
							    <p class="col-lg-8 col-md-6 col-sm-6">#</p>

							    <p class="col-lg-4 col-md-6 col-sm-6"><small>Project Requirement</small></p>
							    <p class="col-lg-8 col-md-6 col-sm-6">#</p>

							    <p class="col-lg-4 col-md-6 col-sm-6"><small>Scrum Team</small></p>
							    <p class="col-lg-8 col-md-6 col-sm-6">{{ticket.priority.code}}</p>

							    <p class="col-lg-4 col-md-6 col-sm-6"><small>Automated Testing</small></p>
							    <p class="col-lg-8 col-md-6 col-sm-6">#</p>

							    <p class="col-lg-4 col-md-6 col-sm-6"><small>Priority</small></p>
							    <p class="col-lg-8 col-md-6 col-sm-6">
                                <select id="priority" data-show-content="true" class="form-control">
                                    {% for jp in jiraPriorities %}
                                        {% if jp.code == ticket.priority.code %}
                                        <option data-content="<img src='{% static jp.icon %}' width='20' height='20'>&nbsp; {{jp}}" selected="selected" value="{{jp.code}}">{{jp.internalKey}}</option>
                                        {% else %}
                                        <option data-content="<img src='{% static jp.icon %}' width='20' height='20'>&nbsp; {{jp}}" value="{{jp.code}}">{{jp.internalKey}}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>                     
                                </p>

							    <p class="col-lg-4 col-md-6 col-sm-6"><small>Epic Name</small></p>
							    <p class="col-lg-8 col-md-6 col-sm-6">#</p>

							    <p class="col-lg-4 col-md-6 col-sm-6"><small>Epic Status</small></p>
							    <p class="col-lg-8 col-md-6 col-sm-6">#</p>
							</dl>
                        </div>
                    </div>
                </div>
            </div>
            <br>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
<script type="text/javascript">

    window.onload = function()
    {
        // ticket baseInformation
        data = {
            "ticketSummary": "{{ticket.summary}}",
            "ticketDescription": "{{ticket.description}}",
            "ticketUserImpact": "{{ticket.userImpact}}",
            "ticketReleaseImpact": "{{ticket.releaseImpact}}",
            "ticketAutomaticTestingReason": "{{ticket.automatedTestingReason}}",
        }
        localStorage.setItem('ticketInitialData', JSON.stringify(data));
    }

    function updateTicketBaseData()
    {
        var ticketInitialData = localStorage.getItem('ticketInitialData');
        var ticketInitialData = JSON.parse(ticketInitialData);

        var ticketSummary = $( "#ticket-summary" ).val();
        var ticketDescription = $('[name="ticket-description"]').val();
        var ticketUserImpact = $('[name="ticket-user-impact"]').val();
        var ticketReleaseImpact = $('[name="ticket-release-impact"]').val();
        var ticketAutomaticTestingReason = $('[name="ticket-automatic-testing-reason"]').val();

        var toUpdate = {};

        if (ticketInitialData.ticketSummary != ticketSummary)
        {
            toUpdate.ticketSummary = ticketSummary;
            ticketInitialData.ticketSummary = ticketSummary;
        }

        if (ticketInitialData.ticketDescription != ticketDescription)
        {
            toUpdate.ticketDescription = ticketDescription;
            ticketInitialData.ticketDescription = ticketDescription;
        }

        if (ticketInitialData.ticketUserImpact != ticketUserImpact)
        {
            toUpdate.ticketUserImpact = ticketUserImpact;
            ticketInitialData.ticketUserImpact = ticketUserImpact;
        }

        if (ticketInitialData.ticketReleaseImpact != ticketReleaseImpact)
        {
            toUpdate.ticketReleaseImpact = ticketReleaseImpact;
            ticketInitialData.ticketReleaseImpact = ticketReleaseImpact;
        }

        if (ticketInitialData.ticketAutomaticTestingReason != ticketAutomaticTestingReason)
        {
            toUpdate.ticketAutomaticTestingReason = ticketAutomaticTestingReason;
            ticketInitialData.ticketAutomaticTestingReason = ticketAutomaticTestingReason;
        }

        localStorage.setItem('ticketInitialData', JSON.stringify(ticketInitialData));

        if (Object.keys(toUpdate).length == 0)
            return;

        $.ajax(
            {
                url: "{% url 'jira2:ticketObjectBaseDataUpdateApiEventVersion1Component' ticketId=ticket.id %}",
                data: toUpdate,
                type: "PUT",
                dataType: 'json',
            }
        );
    }

    $( "#ticket-summary" ).focusout(function() {
        updateTicketBaseData();
    });

    $( "#priority" ).change( function() {
        $.ajax(
            {
                data:
                {
                    'update-ticket-priority': this.value,
                },
                dataType: 'json',
            }
        );
    });

    $('#priority').selectpicker();
</script>
<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
{% endblock %}