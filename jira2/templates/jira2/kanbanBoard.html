{% extends "accounts/account_base.html" %}
{% load static %}
{% block content %}
<link type="text/css" rel="stylesheet" href="{% static 'css/file1.css' %}" data-wrm-key="_super,-_sync" data-wrm-batch-type="context" media="all">
<link type="text/css" rel="stylesheet" href="{% static 'css/file2.css' %}">
<link type="text/css" rel="stylesheet" href="{% static 'css/file1.css' %}" data-wrm-key="_super,-_sync" data-wrm-batch-type="context" media="all">
<link type="text/css" rel="stylesheet" href="{% static 'css/file2.css' %}?agile_global_admin_condition=true&amp;flexboards=true&amp;jag=true&amp;jaguser=true&amp;slack-enabled=true&amp;user-logged-in=true" data-wrm-key="gh-rapid-work,atl.general,greenhopper-rapid-non-gadget,jira.project.sidebar,atl.global,jira.global,jira.general,com.atlassian.jira.projects.sidebar.init,-_super" data-wrm-batch-type="context" media="all">
<link type="text/css" rel="stylesheet" href="{% static 'css/file3.css' %}" data-wrm-key="gh-rapid-charts,-_super" data-wrm-batch-type="context" media="all">
<link type="text/css" rel="stylesheet" href="{% static 'css/file4.css' %}" data-wrm-key="com.atlassian.jira.jira-tzdetect-plugin:tzdetect-banner-component" data-wrm-batch-type="resource" media="all">
<body class=" ghx-agile ghx-rapid-views aui-page-sidebar aui-sidebar-collapsed ghx-scroll-columns ">
    <div id="page">
        <div id="announcement-banner" class="alertHeader">
        </div>
        <div id="content">
            <section class="aui-sidebar projects-sidebar fade-in" resolved="" aria-expanded="false" id="sidebar" aria-label="Sidebar">
                <div class="aui-sidebar-wrapper" style="height: 583px;">
                </div>
            </section>
            <main role="main" id="main" class="ghx-gh  aui-page-panel">
                <div id="gh" class="ghx-no-touch">
                    <div id="ghx-header">
                        <div id="ghx-modes-tools">
                            <div id="ghx-view-modes" style=""></div>
                            <span id="ghx-view-pluggable" style="visibility: visible;">
                                <div class="ghx-view-section ">
                                    <button id="ticket-button-creation-button" class="aui-button aui-dropdown2-trigger">New ticket</button>
                                    <button id="board-tools-section-button" class="aui-button aui-dropdown2-trigger" aria-controls="board-tools-section-content" resolved="" aria-haspopup="true" aria-expanded="false">Board</button>
                                    <aui-dropdown-menu id="board-tools-section-content" hidden="" resolved="" role="menu" class="aui-dropdown2 aui-layer" tabindex="-1"></aui-dropdown-menu>
                                </div>
                            </span>
                            <div id="ghx-view-tools"></div>
                            <div id="ghx-view-presentation"><button class="aui-button ghx-compact-toggle js-compact-toggle" title="Hide the header ( Z )" aria-label="Hide the header" resolved=""><span class="aui-icon aui-icon aui-icon-small aui-iconfont-vid-full-screen-on"></span></button></div>
                        </div>
                        <div id="ghx-view-selector">
                            <h1>
                              <!-- <span id="ghx-board-name" class="subnav-page-header">WA PET Board</span> -->
                              <span class="subnav-container">
                                <span id="subnav-title">
                                  <span class="subnavigator-title" title="Kanban board">{{board.name}} board</span>
                                </span>
                                <span id="subnav-trigger"></span>
                                <span id="subnav-opts"></span>
                              </span>
                            </h1>
                        </div>
                    </div>
                    <div id="ghx-content-main" class="ghx-content-main">
                        <div id="ghx-errors"></div>
                        <div id="ghx-notify" style="display: none;"></div>
                        <div id="ghx-rabid" style="">
                            <div id="ghx-operations">
                                <div id="ghx-controls">
                                    <div id="ghx-controls-plan" class="ghx-controls-plan ghx-controls-list" style="display: none;"></div>
                                    <div id="ghx-controls-work" class="ghx-controls-work ghx-controls-list">
                                        <div class="ghx-controls-filters js-quickfilter-selector">
                                            <dl id="js-work-quickfilters" class="aui-expander-content ghx-quick-content">
                                                <dt id="js-quickfilters-label" class="ghx-cursor-help" title="Use Quick Filters to view a subset of issues. Board owners can add more.">Quick Filters:</dt>
                                                <dd><a role="button" href="#" class="js-quickfilter-button aui-button aui-button-link first  " title="Displays only WA_PET Tickets for specific duration (PET_LIVE_SUPPORT + PET_TECH_IMPROVMENT" data-filter-id="13911" resolved="">Reports - Created in Last week</a></dd>
                                                <dd><a role="button" href="#" class="js-quickfilter-button aui-button aui-button-link   " title="assignee = Name.Name " data-filter-id="13090" resolved="">Name</a></dd>
                                                <dd><a role="button" href="#" class="js-quickfilter-button aui-button aui-button-link   " title="assignee = Name.Name " data-filter-id="13009" resolved="">Name</a></dd>
                                                <dd><a role="button" href="#" class="js-quickfilter-button aui-button aui-button-link   " title="Displays issues which are currently assigned to the current user" data-filter-id="12956" resolved="">Only My Issues</a></dd>
                                                <dd><a role="button" href="#" class="js-quickfilter-button aui-button aui-button-link  last " title="Displays issues which have been updated in the last day" data-filter-id="12957" resolved="">Recently Updated</a></dd>
                                                <dd class="ghx-quickfilter-trigger" style="display: none;"><a id="js-work-quickfilters-trigger" data-replace-text="Ã¢â‚¬Â¦ Show fewer" class="aui-expander-trigger" aria-controls="js-work-quickfilters">Ã¢â‚¬Â¦ Show more</a></dd>
                                            </dl>
                                        </div>
                                        <button class="aui-button ghx-compact-toggle js-compact-toggle" title="Show the header ( Z )" aria-label="Show the header" resolved=""><span class="aui-icon aui-icon aui-icon-small aui-iconfont-vid-full-screen-off"></span></button>
                                    </div>
                                    <div id="ghx-controls-report" class="ghx-controls-report" style="display: none;"></div>
                                </div>
                            </div>
                            <div id="ghx-plan" style="display: none;"></div>
                            <div id="ghx-report" class="ghx-chart" style="display: none;"></div>
                            <div id="ghx-work" class="ghx-work">
                                <div id="ghx-pool-column">
                                    <div id="ghx-pool-wrapper">
                                        <div id="ghx-column-header-group" class="ghx-column-header-group ghx-has-stats">
                                            <ul id="ghx-column-headers" class="ghx-column-headers">
                                            </ul>
                                        </div>
                                        <div id="ghx-pool" data-skate-ignore="" class="ghx-has-swimlanes ghx-band-2" style="display: block;">
                                            <div class="ghx-swimlane" swimlane-id="4693" data-card-color-strategy="none">
                                                <ul class="ghx-columns" id="ghx-columns-body">
                                                </ul>
                                            </div>
                                            <span id="js-pool-end" data-rendered="1653574328783"></span>
                                        </div>
                                    </div>
                                </div>
                                <div id="ghx-detail-view" class="ghx-detail-view gh-editable-detail-view" style="width: 400px; display: none;"></div>
                            </div>
                            <div id="ghx-team"></div>
                        </div>
                    </div>
                    <div class="ghx-throbber"></div>
                </div>
            </main>
        </div>
    </div>
</body>
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script type="text/javascript">


   function renderColumnsHeader(data)
   {
      var result = "";

      for (const column of data.columns)
      {
         result += `
            <li class="ghx-column" data-id=${column.id}">
               <div class="ghx-column-header-content">
                  <div class="ghx-column-header-left">
                     <h6 class="ghx-column-title" aria-describedby="aui-tooltip">${column.name}</h6>
                     <div class="ghx-qty">
                        <h6 id="ticket-counter-${column.id}">X of X</h6>
                     </div>
                  </div>
                  <div class="ghx-limits"></div>
               </div>
            </li>
         `;
      }

      return result;
   }

   function renderColumnsBody(data)
   {
      var result = "";

      for (const column of data.columns)
      {
         var columnTickets = renderTickets(column.tickets);
         result += `
            <li id="ulColumnId-${column.id}" class="ghx-column ui-sortable connectedSortable" columnId="${column.id}">
            ${columnTickets}
            </li>
         `;
      }

      return result;
   }

   function renderTickets(tickets)
   {
      var result = "";

      for (const ticket of tickets)
      {
         var epicLink = renderEpicLinkComponent(ticket.epic);
         var bottom = renderBottomTicketComponent(ticket);
         result += `
         <div draggable="true" ticketId="${ticket.id}" class="js-detailview ghx-issue js-issue ghx-has-avatar ghx-avatar-not-empty js-parent-drag ghx-type-10001" data-issue-id="595675" data-issue-key="RWA-1396" role="listitem" tabindex="0" aria-label="RWA-1396 Investigate DLQ alert on May 13, 2022 15:33:42 UTC">
            <div class="ghx-issue-content">
               <div class="ghx-issue-fields">
                  <div class="ghx-summary" title="${ticket.summary}"><span class="ghx-inner">${ticket.summary}</span></div>
               </div>
               ${epicLink}
            </div>
            <div class="ghx-grabber ghx-grabber-transparent"></div>
            <div class="ghx-move-count"><b></b></div>
            <div style="margin-top: 10px;">
               ${bottom}
            </div>
         </div>
         `;
      }

      return result;
   }

   function renderEpicLinkComponent(ticket)
   {
    if (ticket == null)
        return "";

    return `
    <div class="ghx-highlighted-fields">
      <div class="ghx-highlighted-field"><span class="aui-label ghx-label-12" title="${ticket.summary}" data-epickey="${ticket.internalKey}">${ticket.summary}</span></div>
   </div>`;
   }

   function renderBottomTicketComponent(ticket)
   {
      var assignee = renderTicketAssigneeComponent(ticket);
      return `
      <div class="row">
         <div class="col">
            <img src="${ticket.issueType.icon}" title=${ticket.issueType.internalKey} class="rounded" style="width: 20px;" loading="lazy">
            <img src="${ticket.priority.icon}" title=${ticket.priority.internalKey} class="rounded" style="width: 20px;" loading="lazy">
            <span class="badge badge-pill badge-light" style="background-color: #e7e7e7; font-size: 14px;">${ticket.storyPoints}</span>
         </div>
         <div class="col text-right">
          ${assignee}
         <div class="ghx-key pull-right" style="padding-top: 4px;">
            <a href="${ticket.link}" title="${ticket.internalKey}" tabindex="-1" class="js-key-link ghx-key-link" style="flex-direction: column;">
               <span class="ghx-issue-key-link">
                  <span class="js-key-link ghx-key-link-project-key">${ticket.internalKey}</span>
               </span>
            </a>
         </div>

         </div>
      </div>
      `;
   }

   function renderTicketAssigneeComponent(ticket)
   {
      if (ticket.assignee == null)
         return "";
      // TODO: Error this filter-by-alt
      return `<img class="avatar" style="width: 2rem; height: 2rem; margin-right: 8px;" filter-by-alt src="https://cdn3.iconfinder.com/data/icons/avatars-round-flat/33/man5-512.png" data-filter-by="alt" loading="lazy">`
   }

   function updateColumnTicketCounter(columns)
   {
    for (const column of columns)
      {
        var columnElement = document.getElementById("ulColumnId-"+column.id);
        $('#ticket-counter-'+column.id).text(columnElement.children.length);
      }
   }

    window.onload = function(e)
    {
        var response = {"success":true,"data":{"board":{"id":7,"name":"SWOT"},"members":[{"id":1,"firstName":"Django","lastName":"Admin","icon":"/media/avatars/hen.png"}],"columns":[{"id":15,"name":"TO DO","tickets":[{"id":113,"summary":"Sample EPIC ticket","internalKey":"JIRA-1","link":"/jira2/ticket/JIRA-1","storyPoints":5,"issueType":{"internalKey":"Epic","icon":"/static/img/epic.jpg"},"priority":{"internalKey":"Minor","icon":"/static/img/ticket-priority/minor.jpg"},"epic":null,"assignee":null}]},{"id":16,"name":"IN Progress","tickets":[{"id":114,"summary":"Sample Story ticket 1","internalKey":"JIRA-2","link":"/jira2/ticket/JIRA-2","storyPoints":"-","issueType":{"internalKey":"Story","icon":"/static/img/story.jpg"},"priority":{"internalKey":"Highest","icon":"/static/img/ticket-priority/highest.jpg"},"epic":{"id":113,"internalKey":"JIRA-1","summary":"Sample EPIC ticket","colour":"#FF0000","link":"/jira2/ticket/JIRA-1"},"assignee":null}]},{"id":17,"name":"Blocked","tickets":[]},{"id":21,"name":"DONE","tickets":[]}]}};

        $.ajax(
        {
            url: "{% url 'jira2:kanbanBoardDetailsAndItemsApiEventVersion1Component' boardId=board.id %}",
            type: "GET",
            dataType: 'json',
            success: function(response)
            {
                if (!response.success)
                    return;

                $('#ghx-column-headers').append(renderColumnsHeader(response.data));
                 $('#ghx-columns-body').append(renderColumnsBody(response.data));
                 updateColumnTicketCounter(response.data.columns);

                $( ".connectedSortable" ).sortable(
                    {
                        // revert: true
                        connectWith: ".connectedSortable"
                    }
                ).disableSelection();

                $( "#draggable" ).draggable(
                    {
                        connectToSortable: "#sortable",
                        helper: "clone",
                        revert: "invalid"
                    }
                );

                $( "ul, li" ).disableSelection();

                for (const column of response.data.columns)
                {
                    $("#ulColumnId-"+column.id).on('DOMNodeInserted', function(e)
                    {
                        var anchorElement = e.target;

                        if (anchorElement.hasAttribute('ticketId'))
                        {
                            var ticketIdToMove = anchorElement.getAttribute('ticketId');
                            var columnId = anchorElement.parentElement.getAttribute('columnId');

                            $.ajax(
                                {
                                    url: `{% url 'jira2:kanbanBoardTicketColumnUpdateApiEventVersion1Component' %}`,                            
                                    data:
                                    {
                                        'column-id': columnId,
                                        'ticket-id': ticketIdToMove,
                                    },
                                    type: 'PUT',
                                    dataType: 'json',
                                    success: function()
                                    {
                                      updateColumnTicketCounter(response.data.columns);
                                    }
                                }
                            );
                        }
                    });


                }
            }
        });
    }
</script>
{% endblock %}