{% extends "accounts/account_base.html" %}
{% load static %}
{% block content %}
<style type="text/css">
	.mtgtlDwEfX{
		font-size:12px;
		padding:3px 8px;
		border-radius:4px;
		text-align:center;
		color:#fff;
		background-color:#000;
		opacity:.64
	}
</style>
<link rel="stylesheet" type="text/css" href="{% static 'css/tutoringTutorProfile.css' %}"/>
<br>
<div class="container-fluid" style="margin: auto;overflow-x: hidden; max-width: 1500px; color: black;">
	<br>
	<span id="span-id-questionAnswer-instance-container-{{questionAnswer.id}}">
		<div class="card">
			<div class="container" style="margin-top:30px;margin-bottom: 30px;">
				<a href="#" class="mtgtlDwEfX" style="display:inline-block;">{{ questionAnswer.subject }}</a>
				{{ questionAnswer.questioner.get_full_name }} asked a question at
				<p style="display:inline-block;" data-toggle="tooltip" data-placement="top">{{ questionAnswer.date }}</p>
				<div>
					<strong id="questionAnswer-question-{{questionAnswer.id}}">{{ questionAnswer.question|linebreaksbr }}</strong>
				</div>
				<br>
				<div style="width: 970px;" id="questionAnswer-answer-{{questionAnswer.id}}">{{ questionAnswer.answer|linebreaksbr }}</div>
				<br>
				<i class='far fa-thumbs-up' style='font-size:15px'></i> ({{questionAnswer.likes.count}}) &nbsp;&nbsp;
				<i class='far fa-thumbs-down' style='font-size:15px'></i> ({{questionAnswer.dislikes.count}})<br><br>

				<hr>

				<div class="container">
					<textarea class="form-control border p-4" id="comment-box" placeholder="write a comment..." rows="3"></textarea>
					<br>
					<div class="pull-right">
						<button type="button" class="btn btn-outline-primary btn-sm" onclick="createQuestionAnswerComment();">Post Comment</button>
					</div>
				</div>
				<br>
				<br>
			</div>
		</div>
		<br>
	</span>
	<br>

	<div id="div-id-questionAnswerComment-container">
	</div>
	
	{% if questionAnswerComment.has_other_pages %}
	<nav aria-label="Page navigation example">
		<ul class="pagination justify-content-center">
			{% if questionAnswerComment.has_previous %}
			<li class="page-item">
				<a class="page-link" href="?page={{ questionAnswerComment.previous_page_number }}" aria-label="Previous">
					<span aria-hidden="true">&laquo;</span>
					<span class="sr-only">Previous</span>
				</a>
			</li>
			{% else %}
			<li class="page-item disabled">
				<a class="page-link" aria-label="Previous">
					<span aria-hidden="true">&laquo;</span>
					<span class="sr-only">Previous</span>
				</a>
			</li>
			{% endif %}

			{% for i in questionAnswerComment.paginator.page_range %}
			{% if questionAnswerComment.number == i %}
			<li class="page-item active"><span class="page-link"> {{ i }} <span class="sr-only">(current)</span></span></li>
			{% else %}
			<li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
			{% endif %}
			{% endfor %}

			{% if questionAnswerComment.has_next %}
			<li class="page-item">
				<a class="page-link" href="?page={{ questionAnswerComment.next_page_number }}" aria-label="Next">
					<span aria-hidden="true">&raquo;</span>
					<span class="sr-only">Next</span>
				</a>
			</li>
			{% else %}
			<li class="page-item disabled">
				<a class="page-link" aria-label="Next">
					<span aria-hidden="true">&raquo;</span>
					<span class="sr-only">Next</span>
				</a>
			</li>
			{% endif %}
		</ul>
	</nav>
	{% endif %}
</div>

<script type="text/javascript">

	window.onload = function()
	{
		collectQuestionAnswerComment();
	}

	var listOfReviews = [];

	function collectQuestionAnswerComment()
	{

		{% for r in questionAnswerComment %}

			listOfReviews.push(
			{
				'id': '{{r.id}}',
				'creatorFullName': '{{r.creator.get_full_name}}',
				'comment': '{{r.comment|linebreaksbr}}',
				'date': '{{r.date}}',
				'likeCount': eval('{{r.likes.count}}'),
				'dislikeCount': eval('{{r.dislikes.count}}'),
				'edited': '{{r.edited}}' == "True" ? true : false,
				'canEdit': '{{ user }}' == '{{ r.creator }}' ? true : false,
			});


		{% endfor %}

		renderQuestionAnswerCommentComponents(listOfReviews);
	}

	function renderQuestionAnswerCommentComponents(list)
	{
		$('#div-id-questionAnswerComment-container').empty();

		if (list.length == 0)
			return;

		for (var i = 0; i < list.length; i++)
		{
			var editedText = list[i].edited == true ? '(edited)' : '';
			var userEditDropdown = editDeleteDropdownComponent(list[i].canEdit, list[i].id);
			
			var newCommentObject = `
			<div class="reviews-members pt-4 pb-4" id="question-answer-component-`+list[i].id+`">
				<div class="media">
					<a href="#"><img alt="Generic placeholder image" src="http://bootdey.com/img/Content/avatar/avatar1.png" class="mr-3 rounded-pill"></a>
					<div class="media-body">
						<div class="reviews-members-header">
							`+userEditDropdown+`
							<h6 class="mb-1"><b>`+list[i].creatorFullName+`</b></h6>
							<p class="text-gray">`+list[i].date+` <span class="text-secondary" >`+editedText+`</span></p>
						</div>
						<div class="reviews-members-body">
							<p id="p-id-questionAnswerComment-comment-container-`+list[i].id+`">`+list[i].comment+`</p>
						</div>
						<div class="reviews-members-footer">
							<button type="button" class="btn btn-outline-primary" style="border-radius: 35px;" onclick="likeOrDislikeQuestionAnswerComment(`+list[i].id+`,`+true+`)">
								<i class="fa fa-thumbs-o-up"></i> `+list[i].likeCount+`
							</button>
							<button type="button" class="btn btn-outline-primary" style="border-radius: 35px;" onclick="likeOrDislikeQuestionAnswerComment(`+list[i].id+`,`+false+`)">
								<i class="fa fa-thumbs-o-down"></i> `+list[i].dislikeCount+`
							</button>
							&nbsp;&nbsp;
						</div>
					</div>
				</div>
			</div>
			<hr>`;

			$('#div-id-questionAnswerComment-container').append( newCommentObject );
		}
	}

	function editDeleteDropdownComponent(canEdit, componentId)
	{
		var response = `<div class="dropdown pull-right" style="display:inline-block;">
							<button type="button" class="btn btn-outline-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
								<div class="dropdown-menu dropdown-primary">`;

		if (canEdit)
		{
			response += `<span class="dropdown-item" style="cursor: pointer;" onclick="deleteQuestionAnswerCommentComponent(`+componentId+`);">
							<i class="fas fa-trash-alt"></i>&nbsp;&nbsp;Delete
						</span>
						<span class="dropdown-item" style="cursor: pointer;" onclick="convertTextToEditArea(`+componentId+`)">
							<i class="fa fa-edit"></i>&nbsp;&nbsp;Edit
						</span>`;
		}
		else
		{
			response += '<span class="dropdown-item"><i class="fa fa-warning"></i>&nbsp;&nbsp;Report</span>';
		}

		response+= `</div></div>`;
		return response;
	}

	function deleteQuestionAnswerCommentComponent(componentId)
	{
		verifyLogin();

		$.ajax(
		{
			data:
			{
				'functionality': 'deleteQuestionAnswerComment',
				'id': componentId,
			},
			dataType: 'json',
			success: function (response)
			{
				if (response.statusCode == 200)
				{
					removeQuestionAnswerCommentFromGlobalReviewList(componentId);
				}
			}
		});
	}

	function removeQuestionAnswerCommentFromGlobalReviewList(componentId)
	{
		var newList = [];
		for (var i = 0; i < listOfReviews.length; i++)
		{
			if (listOfReviews[i].id != componentId)
			{
				newList.push(listOfReviews[i]);
			}
		}
		listOfReviews = newList;    
		renderQuestionAnswerCommentComponents(listOfReviews);
	}


	function convertTextToEditArea(componentId)
	{
		var regex = /<br\s*[\/]?>/gi;

		for (var i = 0; i < listOfReviews.length; i++)
		{
			if (listOfReviews[i].id == componentId)
			{
				$('#p-id-questionAnswerComment-comment-container-'+componentId).empty();
				$('#p-id-questionAnswerComment-comment-container-'+componentId).replaceWith(
					`<textarea id="update-comment-container-`+componentId+`" class="form-control border p-4" rows="3">` + listOfReviews[i].comment.replace(regex, "\n") + `</textarea>
						<div class="pull-right">
							<br>
							<button type="button" class="btn btn-outline-danger" onclick="cancelCommentUpdate();">Cancel</button>
							&nbsp;&nbsp;
							<button type="button" class="btn btn-outline-info" onclick="completeCommentUpdate(`+componentId+`);">Update Comment</button>
							<br><br>
						</div>
						<br>`
					);
				break;
			}
		}
	}

	function cancelCommentUpdate()
	{
		// Simple trick is to re-render all the components from the list rather than reverting that single component to its original HTML <p> element.
		renderQuestionAnswerCommentComponents(listOfReviews);
	}

	function completeCommentUpdate(componentId)
	{
		var comment = $("#update-comment-container-"+componentId).val();
		comment = comment.trim();

		if (comment && !comment.trim() || comment.length==0)
		{
			alert("Enter a comment!");
			return;
		}

		$.ajax(
		{
			data:
			{
				'functionality': 'updateQuestionAnswerComment',
				'id': componentId,
				'comment': comment
			},
			dataType: 'json',
			success: function (response)
			{
				if(response.statusCode == 200)
				{
					for (var i = 0; i < listOfReviews.length; i++)
					{
						if (listOfReviews[i].id == componentId)
						{
							listOfReviews[i].comment = response.updatedComment.comment;
							listOfReviews[i].edited = response.updatedComment.edited;
							break;
						}
					}
					renderQuestionAnswerCommentComponents(listOfReviews);
				}
				else
				{
					Swal.fire({
						icon: 'warning',
						title: "Can't do that!",
						text: response.message
					});
				}
			}
		});
	}

	function verifyLogin()
	{
		{% if not user.is_authenticated %}
			window.location.href = "{% url 'accounts:login' %}";
		{% endif %}
	}

	function createQuestionAnswerComment()
	{
		verifyLogin();
		var comment = $("#comment-box").val();
		comment = comment.trim();

		if (comment && !comment.trim() || comment.length==0)
		{
			alert("Enter a comment!");
			return;
		}

		$("#comment-box").val("");

		$.ajax(
		{
			data:
			{
				'functionality': 'createQuestionAnswerComment',
				'comment': comment
			},
			dataType: 'json',
			success: function (response)
			{
				if(response.statusCode == 200)
				{
					listOfReviews = [response.newComment].concat(listOfReviews);
					renderQuestionAnswerCommentComponents(listOfReviews);
				}
			}
		});
	}

	function likeOrDislikeQuestionAnswerComment(componentId, isLike)
	{
		verifyLogin();
		$.ajax(
		{
			data:
			{
				'functionality': isLike ? 'likeQuestionAnswerComment' : 'dislikeQuestionAnswerComment',
				'id': componentId,
			},
			dataType: 'json',
			success: function (response)
			{
				if (response.statusCode == 200)
				{
					updateQuestionAnswerCommentLikesAndDislikesInGlobalReviewList(componentId, response.likeCount, response.dislikeCount);
					renderQuestionAnswerCommentComponents(listOfReviews);
				}
			}
		});
	}

	function updateQuestionAnswerCommentLikesAndDislikesInGlobalReviewList(componentId, likesCount, dislikeCount)
	{
		for (var i = 0; i < listOfReviews.length; i++)
		{
			if (listOfReviews[i].id == componentId)
			{
				listOfReviews[i].likeCount = eval(likesCount);
				listOfReviews[i].dislikeCount = eval(dislikeCount);
				break;
			}
		}
	}

</script>
{% endblock %}