{% extends "accounts/account_base.html" %}
{% load static %}
{% block content %}
<style type="text/css">
	.profile-sidebar{padding:20px 0 10px 0;background:#fff}.profile-userpic img{float:none;margin:0 auto;width:50%;height:50%;-webkit-border-radius:50%!important;-moz-border-radius:50%!important;border-radius:50%!important}.profile-usertitle{text-align:center;margin-top:20px}.profile-usertitle-name{color:#5a7391;font-size:16px;font-weight:600;margin-bottom:7px}.profile-usertitle-job{text-transform:uppercase;color:#5b9bd1;font-size:12px;font-weight:600;margin-bottom:15px}.profile-userbuttons{text-align:center;margin-top:10px}.profile-userbuttons .btn{text-transform:uppercase;font-size:11px;font-weight:600;padding:6px 15px;margin-right:5px}.profile-userbuttons .btn:last-child{margin-right:0}.mtgtlDwEfX{font-size:12px;padding:3px 8px;border-radius:4px;text-align:center;color:#fff;background-color:#000;opacity:.64}
	@media (min-width: 1200px) {
		.container {
			width: 1600px;
		}
		.wrapper {
			width: 75%;
		}
	}

	@media (min-width: 972px) and (max-width: 1200px) {
		.container {
			width: 1600px;
		}
		.wrapper {
			width: 90%;
		}
	}

	@media (min-width: 700px) and (max-width: 959px) {
		.container {
			width: 1600px;
		}
		.wrapper {
			width: 90%;
		}
	}

	.total-like-user-main a{display:inline-block;margin:0 -17px 0 0}.total-like{border:1px solid;border-radius:50px;display:inline-block;font-weight:500;height:34px;line-height:33px;padding:0 13px;vertical-align:top}.restaurant-detailed-ratings-and-reviews hr{margin:0 -24px}.text-black{color:#000}.reviews-members .media .mr-3{width:56px;height:56px;object-fit:cover}.rounded-pill{border-radius:50rem!important}.total-like-user{border:2px solid #fff;height:34px;box-shadow:0 .125rem .25rem rgba(0,0,0,.075)!important;width:34px}.total-like-user-main a{display:inline-block;margin:0 -17px 0 0}.total-like{border:1px solid;border-radius:50px;display:inline-block;font-weight:500;height:34px;line-height:33px;padding:0 13px;vertical-align:top}.restaurant-detailed-ratings-and-reviews hr{margin:0 -24px}.graph-star-rating-header .star-rating{font-size:17px}.progress{background:#f2f4f8 none repeat scroll 0 0;border-radius:0;height:30px}.rating-list{display:inline-flex;margin-bottom:15px;width:100%}.rating-list-left{height:16px;line-height:29px;width:10%}.rating-list-center{width:80%}.rating-list-right{line-height:29px;text-align:right;width:10%}.text-black{color:#000}.graph-star-rating-header .star-rating{font-size:17px}.progress{background:#f2f4f8 none repeat scroll 0 0;border-radius:0;height:30px}.rating-list{display:inline-flex;margin-bottom:15px;width:100%}.rating-list-left{height:16px;line-height:29px;width:10%}.rating-list-center{width:80%}.rating-list-right{line-height:29px;text-align:right;width:10%}.progress{background:#f2f4f8 none repeat scroll 0 0;border-radius:0;height:30px}

</style>
<div class="profile-userbuttons">
	<div class="modal fade" id="questionModal" tabindex="-1" role="dialog" aria-labelledby="questionModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content" style="color: black;">
				<div class="modal-header">
					<h3 class="modal-title" id="exampleModalLabel" style="display: inline-block;">Enter your Question below.</h3>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close" style="display: inline-block;">
					<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label for="subject-related" class="col-form-label pull-left"><b>Select a subject</b></label>
						<select class="form-control" id="subject" name="subject">
							{% for subject in subjects %}
							<option value="{{subject.name}}">{{subject.name}}</option>
							{% endfor %}
						</select>
					</div>
					<div class="form-group">
						<label for="question" class="col-form-label pull-left"><b>Question:</b></label>
						<textarea class="form-control" id="question" name="question" required></textarea>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
						<button type="submit" class="btn btn-success" onclick="postQuestionAnswer();">Post my Question</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="modal fade" id="tutorReview" tabindex="-1" role="dialog" aria-labelledby="tutorReviewLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content" style="color: black;">
			<div class="modal-header">
				<h3 class="modal-title" id="exampleModalLabel" style="display: inline-block;">Enter your review below.</h3>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close" style="display: inline-block;">
				<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<div class="form-group">
					<label for="rating_value-related" class="col-form-label pull-left"><b>Rating:</b></label>
					<select class="form-control" id="rating_value" name="rating_value">
						<option value="0">0</option>
						<option value="1">1</option>
						<option value="2">2</option>
						<option value="3">3</option>
						<option value="4">4</option>
						<option value="5">5</option>
					</select>
				</div>
				<div class="form-group">
					<label for="review_comment" class="col-form-label pull-left"><b>Comment:</b></label>
					<textarea class="form-control" id="review_comment" name="review_comment" rows="5" required></textarea>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
					<button type="submit" class="btn btn-success" onclick="post_review();">Post my review</button>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="wrapper" style="margin: auto;overflow-x: hidden;">
	<br>
	<div class="row gutters-sm">
		<div class="col-lg-3 d-md-block">
			<div class="card">
				<div class="card-body">
					<div class="d-flex flex-column align-items-center text-center">
						{% if tutorProfile.profilePicture %}
						<img src="{{ tutorProfile.profilePicture.url }}" class="rounded-circle" width="150" height="150" alt="Error" />
						{% else %}
						<img src="https://icon-library.com/images/default-user-icon/default-user-icon-13.jpg" class="rounded-circle" width="150" height="150" alt="Error" />
						{% endif %}
						<div class="mt-3">
							<h4 style="color: black;">{{ tutorProfile.user.first_name }} {{ tutorProfile.user.last_name }}</h4>
							<p class="text-secondary mb-1">{{ tutorProfile.summary }}</p>
							{% if user.pk != tutorProfile.user.pk %}
							<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#questionModal">Ask a Question</button>
							<button type="button" class="btn btn-outline-primary" onclick="StartMessage();">Message</button>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
			<br>
			<div class="card" style="color: black;">
				<nav class="nav flex-column nav-pills nav-gap-y-1">
					<a href="#tutor_profile" data-toggle="tab" class="nav-item nav-link has-icon nav-link-faded active">
					<i class='fa fa-user' style='font-size:20px'></i>
					&nbsp;&nbsp;
					<label class="side-bar-text">Profile</label>
					</a>
					<a href="#q_and_a" data-toggle="tab" class="nav-item nav-link has-icon nav-link-faded">
					<i class='fas fa-question' style='font-size:20px'></i>
					&nbsp;&nbsp;
					<label class="side-bar-text">Q and A</label>
					</a>
					<a href="#tutor_reviews" data-toggle="tab" class="nav-item nav-link has-icon nav-link-faded">
					<i class='fa fa-star' style='font-size:20px'></i>
					&nbsp;&nbsp;
					<label class="side-bar-text">Reviews</label>
					</a>
				</nav>
			</div>
		</div>
		<div class="col-lg-9">
			<div class="card">
				<div class="card-body tab-content" style="color: black;">
					<div class="tab-pane active" id="tutor_profile">
						<div>
							<h3>About</h3>
							<p>{{ tutorProfile.about|linebreaksbr }}</p>
						</div>
						<hr>
						<br>
						<div>
							<h3>Education</h3>
							<div>
								{% for key,value in tutorProfile.education.items %}
								<div style="display: flex; flex-direction: row; align-items: flex-start; justify-content: flex-start; margin-bottom: 15px;">
									<img src="https://www.iconfinder.com/data/icons/building-1/512/build2-512.png"
										style="width: 50px; height: 50px; margin-right: 13px; -o-object-fit: contain; object-fit: contain; border-radius: 4px;">
									<div style="flex: 1 1; flex-direction: column;">
										<b style="margin-bottom: 5px;">{{value.school_name}}</b>
										<p style="margin-bottom: 0;">{{value.qualification}} ({{value.year}})</p>
									</div>
								</div>
								{% endfor %}
							</div>
						</div>
						<hr>
						<br>
						<div>
							<div class="row">
								<div class="col-sm-6">
									<h3 for="availability">Availability</h3>
									<table class="table" id="availabilitySchedule" style="width: auto;">
										<thead>
											<tr>
												<th scope="col"></th>
												<th scope="col">Morning</th>
												<th scope="col">Afternoon</th>
												<th scope="col">Evening</th>
											</tr>
										</thead>
										<tbody>
											{% for key,value in tutorProfile.availability.items %}
											<tr>
												<th style="vertical-align: middle;" scope="row">{{key|title}}</th>
												<td style="text-align: center">
													{% if value.morning %}
													<div class="btn-group" data-toggle="buttons">
														<label class="btn btn-success" disabled> <i class="fas fa-check"></i>
														</label>
													</div>
													{% else %}
													<div class="btn-group" data-toggle="buttons">
														<label class="btn btn-danger" disabled> <i class="fas fa-times"></i>
														</label>
													</div>
													{% endif %}
												</td>
												<td style="text-align: center">
													{% if value.afternoon %}
													<div class="btn-group" data-toggle="buttons">
														<label class="btn btn-success" disabled> <i class="fas fa-check"></i>
														</label>
													</div>
													{% else %}
													<div class="btn-group" data-toggle="buttons">
														<label class="btn btn-danger" disabled> <i class="fas fa-times"></i>
														</label>
													</div>
													{% endif %}
												</td>
												<td style="text-align: center">
													{% if value.evening %}
													<div class="btn-group" data-toggle="buttons">
														<label class="btn btn-success" disabled> <i class="fas fa-check"></i>
														</label>
													</div>
													{% else %}
													<div class="btn-group" data-toggle="buttons">
														<label class="btn btn-danger" disabled> <i class="fas fa-times"></i>
														</label>
													</div>
													{% endif %}
												</td>
											</tr>
											{% endfor %}
										</tbody>
									</table>
								</div>
								<div class="col-sm-6">
									<h3>Subjects</h3>
									<div style="display: flex; flex-flow: row wrap;" id="list_of_subjects">
										<!-- {% for subject in tutorProfile.subjects %} <a href="" style="margin:
											0 10px 10px 0;">
											
											<dir class="mtgtlDwEfX">
											
											{{ subject }}
											
											</dir>
											
											</a>
											
											{% endfor %} -->
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="tab-pane" id="q_and_a">
						<div class="modal fade" id="answerModal" tabindex="-1" role="dialog" aria-labelledby="answerModalLabel" aria-hidden="true">
							<div class="modal-dialog" role="document">
								<div class="modal-content" style="color: black;">
									<div class="modal-header">
										<h3 class="modal-title" id="exampleModalLabel" style="display: inline-block;">Answer the Question below.</h3>
										<button type="button" class="close" data-dismiss="modal" aria-label="Close" style="display: inline-block;">
										<span aria-hidden="true">&times;</span>
										</button>
									</div>
									<div class="modal-body">
										<!-- <form method="post"> -->
										<!-- {% csrf_token %} -->
										<div class="form-group">
											<label for="question_text" class="col-form-label pull-left">Question</label>
											<textarea class="form-control" id="question_text" name="question_text" readonly></textarea>
										</div>
										<div class="form-group">
											<label for="answer_text" class="col-form-label pull-left">Answer</label>
											<textarea class="form-control" id="answer_text" name="answer_text" required></textarea>
										</div>
										<input type="text" name="question_id" id="question_id" hidden/>
										<div class="modal-footer">
											<button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
											<button type="submit" class="btn btn-success" onclick="answerQuestionAnswer();">Post my Answer</button>
										</div>
										<!-- </form> -->
									</div>
								</div>
							</div>
						</div>
						<!-- TOEDIT -->
						<div class="modal fade" id="editQuestionModal" tabindex="-1" role="dialog" aria-labelledby="editQuestionModalLabel" aria-hidden="true">
							<div class="modal-dialog" role="document">
								<div class="modal-content" style="color: black;">
									<div class="modal-header">
										<h3 class="modal-title" id="exampleModalLabel" style="display: inline-block;">Edit your question below.</h3>
										<button type="button" class="close" data-dismiss="modal" aria-label="Close" style="display: inline-block;">
										<span aria-hidden="true">&times;</span>
										</button>
									</div>
									<div class="modal-body">
										<div class="form-group">
											<label for="subject-related" class="col-form-label pull-left"><b>Select a subject</b></label>
											<select class="form-control" id="editQuestionSubject" name="subject">
												<!-- {% for subject in subjects %}
													<option value="{{subject.name}}">{{subject.name}}</option>
													{% endfor %} -->
											</select>
										</div>
										<div class="form-group">
											<label for="question" class="col-form-label pull-left"><b>Question:</b></label>
											<textarea class="form-control" id="new_question" name="new_question" required></textarea>
										</div>
										<input type="text" name="question_id_to_update" id="question_id_to_update" hidden/>
										<div class="modal-footer">
											<button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
											<button type="submit" class="btn btn-primary" onclick="updateQuestion();">Update my Question</button>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div style="overflow-y: scroll; overflow-x: hidden; height:866px;" id="div-id-tutor-QuestionAnswer">
							{% if questionAndAnswers %} {% for qa in questionAndAnswers %}
							<div class="container question_answer_container_{{qa.id}}" style="width: auto;">
								<div id="question_answer_id_{{qa.id}}">
									<a href="/subject_tag/{{qa.subject}}" class="mtgtlDwEfX" style="display:inline-block;" id="qa_subject_{{qa.id}}">{{ qa.subject }}</a>
									{{ qa.questioner.first_name }} {{ qa.questioner.last_name }} asked a question at
									<p style="display:inline-block;" id="tool_tip_date_{{qa.id}}" data-toggle="tooltip" data-placement="top">{{ qa.date }}</p>
									<div class="dropdown pull-right" style="display:inline-block;">
										<!--Trigger-->
										<a class="btn-floating btn-lg black dropdown-toggle"type="button" id="dropdownMenu3" data-toggle="dropdown"
											aria-haspopup="true" aria-expanded="false"><i class="fas fa-ellipsis-v"></i></a>
										<br>
										<!--Menu-->
										<div class="dropdown-menu dropdown-primary">
											{% if qa.questioner.pk == user.pk %}
											<span class="dropdown-item" style="cursor: pointer;" onclick="deleteQuestionAnswer('{{qa.id}}');"><i class="fas fa-trash-alt"></i>&nbsp;&nbsp;Delete question</span>
											<a class="dropdown-item" href="#" data-toggle="modal" data-target="#editQuestionModal" onclick="updateEditQuestionModal('{{ qa.id }}');"><i class="fas fa-edit"></i>&nbsp;&nbsp;Edit question</a>
											{% endif %}
											<a class="dropdown-item" href="{% url 'tutoring:question_answer_thread' qa.id %}" target="_blank"><i class="fab fa-discourse"></i>&nbsp;&nbsp;View thread</a>
										</div>
									</div>
								</div>
								<div><strong id="qa_question_{{qa.id}}">{{ qa.question|linebreaksbr }}</strong></div>
								<br>
								<div style="width: 970px;" id="qa_answer_{{qa.id}}">{{ qa.answer|linebreaksbr }}</div>
								<br>
								<button id="comment_like_id_{{qa.id}}" type="button" class="btn btn-default btn-sm" onclick="likeQuestionAnswer('{{qa.id}}')">
								<i class='far fa-thumbs-up' style='font-size:15px'></i> ({{qa.likes.count}})
								</button>
								<button id="comment_dislike_id_{{qa.id}}" type="button" class="btn btn-default btn-sm" onclick="dislikeQuestionAnswer('{{qa.id}}')">
								<i class='far fa-thumbs-down' style='font-size:15px'></i> ({{qa.dislikes.count}})
								</button><br><br>
								<span class="badge badge-info" data-toggle="modal" data-target="#answerModal" onclick="updateAnswerModal('{{ qa.id }}');">Answer this question</span>
								<hr>
							</div>
							{% endfor %} {% endif %}
						</div>
					</div>
					<div class="tab-pane" id="tutor_reviews">
						<div class="bg-white rounded shadow-sm p-4 mb-4 clearfix graph-star-rating">
							<h5 class="mb-0 mb-4">Ratings and Reviews</h5>
							<div class="graph-star-rating-header">
								<div class="star-rating">
									<a href="#"><i class="icofont-ui-rating active"></i></a>
									<a href="#"><i class="icofont-ui-rating active"></i></a>
									<a href="#"><i class="icofont-ui-rating active"></i></a>
									<a href="#"><i class="icofont-ui-rating active"></i></a>
									<a href="#"><i class="icofont-ui-rating"></i></a> <b class="text-black ml-2">{{ tutorReviews.count }} total reviews</b>
								</div>
								<p class="text-black mb-4 mt-2">Rated 3.5 out of 5</p>
							</div>
							<div class="graph-star-rating-body">
								<div class="rating-list">
									<div class="rating-list-left text-black">
										5 Star
									</div>
									<div class="rating-list-center">
										<div class="progress">
											<div id="star-5-bar" style="width: 0%" aria-valuemax="5" aria-valuemin="0" aria-valuenow="5" role="progressbar" class="progress-bar bg-primary">
												<span class="sr-only">80% Complete (danger)</span>
											</div>
										</div>
									</div>
									<div id="star-5-value" class="rating-list-right text-black">56%</div>
								</div>
								<div class="rating-list">
									<div class="rating-list-left text-black">
										4 Star
									</div>
									<div class="rating-list-center">
										<div class="progress">
											<div id="star-4-bar" style="width: 0%" aria-valuemax="5" aria-valuemin="0" aria-valuenow="5" role="progressbar" class="progress-bar bg-primary">
												<span class="sr-only">80% Complete (danger)</span>
											</div>
										</div>
									</div>
									<div id="star-4-value" class="rating-list-right text-black">0%</div>
								</div>
								<div class="rating-list">
									<div class="rating-list-left text-black">
										3 Star
									</div>
									<div class="rating-list-center">
										<div class="progress">
											<div id="star-3-bar" style="width: 0%" aria-valuemax="5" aria-valuemin="0" aria-valuenow="5" role="progressbar" class="progress-bar bg-primary">
												<span class="sr-only">80% Complete (danger)</span>
											</div>
										</div>
									</div>
									<div id="star-3-value" class="rating-list-right text-black">0%</div>
								</div>
								<div class="rating-list">
									<div class="rating-list-left text-black">
										2 Star
									</div>
									<div class="rating-list-center">
										<div class="progress">
											<div id="star-2-bar" style="width: 0%" aria-valuemax="5" aria-valuemin="0" aria-valuenow="5" role="progressbar" class="progress-bar bg-primary">
												<span class="sr-only">80% Complete (danger)</span>
											</div>
										</div>
									</div>
									<div id="star-2-value" class="rating-list-right text-black">0%</div>
								</div>
								<div class="rating-list">
									<div class="rating-list-left text-black">
										1 Star
									</div>
									<div class="rating-list-center">
										<div class="progress">
											<div id="star-1-bar" style="width: 0%" aria-valuemax="5" aria-valuemin="0" aria-valuenow="5" role="progressbar" class="progress-bar bg-primary">
												<span class="sr-only">80% Complete (danger)</span>
											</div>
										</div>
									</div>
									<div id="star-1-value" class="rating-list-right text-black">0%</div>
								</div>
								<div class="rating-list">
									<div class="rating-list-left text-black">
										0 Star
									</div>
									<div class="rating-list-center">
										<div class="progress">
											<div id="star-0-bar" style="width: 0%" aria-valuemax="5" aria-valuemin="0" aria-valuenow="5" role="progressbar" class="progress-bar bg-primary">
												<span class="sr-only">80% Complete (danger)</span>
											</div>
										</div>
									</div>
									<div id="star-0-value" class="rating-list-right text-black">0%</div>
								</div>
							</div>
							<div class="graph-star-rating-footer text-center mt-3 mb-3">
								<button type="button" class="btn btn-outline-primary btn-sm" data-toggle="modal" data-target="#tutorReview">Rate and Review</button>
							</div>
						</div>
						<div class="bg-white rounded shadow-sm p-4 mb-4 restaurant-detailed-ratings-and-reviews">
							<select class="form-control pull-right" id="comment_filter" name="comment_filter" style="width:15%;" onchange="UpdateRatingOrder();">
								<option value="Recent Date">Recent Date</option>
								<option value="Likes">Likes</option>
								<option value="Dislikes">Dislikes</option>
								<option value="Rating">Rating</option>
							</select>
							<h5 class="mb-1">All Ratings and Reviews</h5>
							<div id="tutor_review_comment_section">
								
							</div>

							{# <a class="text-center w-100 d-block mt-4 font-weight-bold" href="#">See All Reviews</a> #}
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
	window.onload = function() {
		update_subjects();
		CollectTutorReviewsHandler();
	}

	var list_of_reviews = [];

	function CollectTutorReviewsHandler() {
		var rating_value_count = [0, 0, 0, 0, 0, 0];
		var rating_value_percantage = [];

		{% for r in tutorReviews %}

			list_of_reviews.push({
				'pk': '{{r.id}}',
				'reviewer_id': '{{r.reviewer.id}}',
				'date': '{{r.date}}',
				'reviewer_full_name': '{{r.reviewer.get_full_name}}',
				'rating': eval('{{r.rating}}'),
				'comment': '{{r.comment|linebreaksbr}}',
				'likes_count': eval('{{r.likes.count}}'),
				'dislikes_count': eval('{{r.dislikes.count}}'),
				'edited': '{{r.edited}}' == "True" ? true : false,
				'can_edit': '{{ user.id }}' == '{{ r.reviewer.id }}' ? true : false,
			});

			rating_value_count[eval('{{r.rating}}')] += 1;

		{% endfor %}

		var total_count = rating_value_count.reduce((a, b) => a + b, 0);
		if (total_count > 0) {
			for(var i = 0; i <rating_value_count.length; i++) {
				rating_value_percantage.push(Math.round(rating_value_count[i]/total_count * 100));
			}
			DisplayReviewStatistics(rating_value_percantage);
		}
		
		ParseTutorReviewToDisplay(list_of_reviews);
	}

	function DisplayReviewStatistics(statistics) {

		for (var i = 0; i < statistics.length; i++) {
			$('#star-'+i+'-bar').css("width", statistics[i]+"%");
			$('#star-'+i+'-value').text(statistics[i]+"%");
		}
	}

	function UpdateRatingOrder() {
		var filter_value = $('#comment_filter').val();

		switch(filter_value) {
			case "Recent Date":
				updateByRecentDate();
				break;
			case "Likes":
				updateByLikes();
				break;
			case "Dislikes":
				updateByDislikes();
				break;
			case "Rating":
				updateByRating();
				break;
			default:
				return;

		}
	}

	function updateByRecentDate() {
		ParseTutorReviewToDisplay(list_of_reviews);
	}

	function updateByLikes() {
		var new_array = list_of_reviews.slice();
		new_array.sort(SorByLikesInDescendingOrder);
		ParseTutorReviewToDisplay(new_array);
	}

	function updateByDislikes() {
		var new_array = list_of_reviews.slice();
		new_array.sort(SorByDislikesInDescendingOrder);
		ParseTutorReviewToDisplay(new_array);
	}

	function updateByRating() {
		var new_array = list_of_reviews.slice();
		new_array.sort(SorByRatingInDescendingOrder);
		ParseTutorReviewToDisplay(new_array);
	}

	function SorByRatingInDescendingOrder( a, b ) { if ( a.rating > b.rating ){ return -1; } if ( a.rating < b.rating ){ return 1; } return 0; }
	function SorByLikesInDescendingOrder( a, b ) { if ( a.likes_count > b.likes_count ){ return -1; } if ( a.likes_count < b.likes_count ){ return 1; } return 0; }
	function SorByDislikesInDescendingOrder( a, b ) { if ( a.dislikes_count > b.dislikes_count ){ return -1; } if ( a.dislikes_count < b.dislikes_count ){ return 1; } return 0; }

	function ParseTutorReviewToDisplay(list) {
		$('#tutor_review_comment_section').empty();

		if (list.length == 0)
			return;

		for (var i = 0; i < list.length; i++) {

			var edited_text = list[i].edited == true ? '(edited)' : '';
			var user_edit_dropdown = GetTutorReviewDropdownForUser(list[i].can_edit, list[i].pk);
			
			var new_comment = `
			<div class="reviews-members pt-4 pb-4" id="tutor_review_container_`+list[i].pk+`">
				<div class="media">
					<a href="#"><img alt="Generic placeholder image" src="http://bootdey.com/img/Content/avatar/avatar1.png" class="mr-3 rounded-pill"></a>
					<div class="media-body">
						<div class="reviews-members-header">
							`+user_edit_dropdown+`
							<h6 class="mb-1"><b>`+list[i].reviewer_full_name+`</b></h6>
							<p class="text-gray">`+list[i].date+` <span class="text-secondary" >`+edited_text+`</span></p>
						</div>
						<div class="reviews-members-body">
							<p id="tutor_review_comment_container_`+list[i].pk+`">`+list[i].comment+`</p>
						</div>
						<div class="reviews-members-footer">
							<button type="button" class="btn btn-outline-primary" style="border-radius: 35px;" onclick="likeTutorReview(`+list[i].pk+`)">
								<i class="fa fa-thumbs-o-up"></i> `+list[i].likes_count+`
							</button>
							<button type="button" class="btn btn-outline-primary" style="border-radius: 35px;" onclick="dislikeTutorReview(`+list[i].pk+`)">
								<i class="fa fa-thumbs-o-down"></i> `+list[i].dislikes_count+`
							</button>
							&nbsp;&nbsp;
							`+GenerateStarsFromRating(list[i].rating);+`
						</div>
					</div>
				</div>
			</div>
			<hr>`;

			$('#tutor_review_comment_section').append( new_comment );
		}
	}

	function likeTutorReview(tutorReviewId)
	{
		$.ajax(
		{
			data:
			{
				'functionality': 'likeTutorReview',
				'id': tutorReviewId,
			},
			dataType: 'json',
			success: function (response)
			{
				if (response.statusCode == 401)
				{
					window.location.href = "{% url 'accounts:login' %}";
				}

				if (response.statusCode == 404)
				{
					Swal.fire({
						icon: 'warning',
						title: "Can't do that!",
						text: response.message
					});
					removeTutorReviewFromGlobalReviewList(tutorReviewId);
				}

				if (response.statusCode == 200)
				{
					updateTutorReviewLikesAndDislikesFromGlobalReviewList(tutorReviewId, response.likeCount, response.dislikeCount);
				}
			}
		});
	}

	function dislikeTutorReview(tutorReviewId)
	{
		$.ajax(
		{
			data:
			{
				'functionality': 'dislikeTutorReview',
				'id': tutorReviewId,
			},
			dataType: 'json',
			success: function (response)
			{

				if (response.statusCode == 401)
				{
					window.location.href = "{% url 'accounts:login' %}";
				}

				if (response.statusCode == 404)
				{
					Swal.fire({
						icon: 'warning',
						title: "Can't do that!",
						text: response.message
					});
					removeTutorReviewFromGlobalReviewList(tutorReviewId);
				}

				if (response.statusCode == 200)
				{
					updateTutorReviewLikesAndDislikesFromGlobalReviewList(tutorReviewId, response.likeCount, response.dislikeCount);
				}
			}
		});

	}

	function updateTutorReviewLikesAndDislikesFromGlobalReviewList(component_id, likesCount, dislikeCount) {
		for (var i = 0; i < list_of_reviews.length; i++) {
			if (list_of_reviews[i].pk == component_id) {
				list_of_reviews[i].likes_count = eval(likesCount);
				list_of_reviews[i].dislikes_count = eval(dislikeCount);
				break;
			}
		}
		ParseTutorReviewToDisplay(list_of_reviews);
	}

	function GetTutorReviewDropdownForUser(can_edit, component_id) {
		var response = `<div class="dropdown pull-right" style="display:inline-block;">
							<button type="button" class="btn btn-outline-primary dropdown-toggle" data-toggle="dropdown"
											aria-haspopup="true" aria-expanded="false"></button>
								<div class="dropdown-menu dropdown-primary">`;

		if (can_edit)
			response += `<span class="dropdown-item" onclick="DeleteTutorReviewComponent(`+component_id+`);"><i class="fas fa-trash-alt"></i>&nbsp;&nbsp;Delete</span>
						<span class="dropdown-item" onclick="ConvertTextToEditArea(`+component_id+`)"><i class="fa fa-edit"></i>&nbsp;&nbsp;Edit</span>`;
		else
			response += '<span class="dropdown-item"><i class="fa fa-warning"></i>&nbsp;&nbsp;Report</span>';

		response+= `</div></div>`;
		return response;
	}

	function ConvertTextToEditArea(component_id) {
		var regex = /<br\s*[\/]?>/gi;

		$('p#tutor_review_comment_container_'+component_id).each(function() {
			$(this).replaceWith(
				`<div id="tutorReviewCommentUpdateTextArea_`+component_id+`">
					<textarea class="form-control border p-4" id="tutorCommentEditBox`+component_id+`" rows="4">`+$(this).html().replace(regex, "\n").trim()+`</textarea>
					<div id="tutorReviewCommentUpdateCommentBtn_`+component_id+`" class="pull-right"><br>
						<button type="button" class="btn btn-outline-danger" onclick="cancelTutorCommentUpdate(`+component_id+`);">Cancel</button>
						&nbsp;&nbsp;
						<button type="button" class="btn btn-outline-info" onclick="updateTutorComment(`+component_id+`);">Update Comment</button>
					</div>
					<div style="height:24px;"></div>
				</div>`
			);
		});
	}

	function DeleteTutorReviewComponent(reviewId)
	{
		$.ajax(
		{
			data:
			{
				'functionality': 'deleteTutorReview',
				'reviewId': reviewId,
			},
			dataType: 'json',
			success: function (response)
			{

				if (response.statusCode == 401)
				{
					window.location.href = "{% url 'accounts:login' %}";
				}


				if (response.status_code == 200)
				{
					removeTutorReviewFromGlobalReviewList(reviewId);
				}
			}
		});
	}

	function removeTutorReviewFromGlobalReviewList(component_id) {
		var new_list = [];
		var rating_value_count = [0, 0, 0, 0, 0, 0];
		var rating_value_percantage = [];
		// no the optimal solution for bigger arrays. 

		for (var i = 0; i < list_of_reviews.length; i++) {
			if (list_of_reviews[i].pk != component_id) {
				new_list.push(list_of_reviews[i]);
				rating_value_count[list_of_reviews[i].rating] += 1;
			}
		}

		var total_count = rating_value_count.reduce((a, b) => a + b, 0);
		if (total_count > 0) {
			for(var i = 0; i <rating_value_count.length; i++) {
				rating_value_percantage.push(Math.round(rating_value_count[i]/total_count * 100));
			}
			DisplayReviewStatistics(rating_value_percantage);
		}
		
		list_of_reviews = new_list;
		ParseTutorReviewToDisplay(list_of_reviews);
	}

	function GenerateStarsFromRating(value) {
		var response = '';

		for (var i = 0; i < value; i++) {
			response += '<i class="fa fa-star" style="font-size:20px;color:lightgreen;"></i>&nbsp;';
		}
		return response;
	}

	function update_subjects() {
		{% for subject in tutorProfile.subjects %}
		var subject_name = "{{subject}}".replace(/\s+/g, '-');
		var subject_item = `
			<a href="/subject_tag/`+subject_name+`" style="margin: 0 10px 10px 0;">
				<dir class="mtgtlDwEfX">
					{{ subject }}
				</dir>
			</a>
			`;
		$( "#list_of_subjects" ).append( subject_item );
		{% endfor %}
	}

	function updateAnswerModal(questionId) {
		var answerText = $('#qa_answer_' + questionId).html();
		var questionText = $('#qa_question_' + questionId).html();
		var regex = /<br\s*[\/]?>/gi;
		document.getElementById('question_id').value = questionId;
		document.getElementById('question_text').value = questionText.replace(regex, "\n");
		document.getElementById('answer_text').value = answerText.replace(regex, "\n");
	}

	function updateEditQuestionModal(questionId) {
		var subjectText = $('#qa_subject_' + questionId).html();
		var questionText = $('#qa_question_' + questionId).html();
		var regex = /<br\s*[\/]?>/gi;

		// display correct subject in the dropdown
		{% for subject in subjects %}
			if (subjectText=='{{subject.name}}') {
				$("#editQuestionSubject").append('<option value="{{subject.name}}" selected>{{subject.name}}</option>');
			} else {
				$("#editQuestionSubject").append('<option value="{{subject.name}}">{{subject.name}}</option>');
			}
		{% endfor %}

		// display correct question text and question id in the modal
		document.getElementById('new_question').value = questionText.replace(regex, "\n");
		document.getElementById('question_id_to_update').value = questionId;
	}

	function updateQuestion()
	{
		var questionId = $('#question_id_to_update').val();
		var subject = $('#editQuestionSubject').find(":selected").text();
		var question = $('textarea#new_question').val();
		question = question.replace(/ +(?= )/g,'');
		question = question.trim();

		if (question && !question.trim() || question.length==0) {
			alert("Enter a question!");
			return;
		}

		// closing the modal and clearing the textarea
		$("#editQuestionModal").modal('hide');
		$("textarea#new_question").val("");

		$.ajax(
		{
			data: {
				'functionality': 'updateQuestion',
				'id': questionId,
				'subject': subject,
				'question': question,
			},
			dataType: 'json',
			success: function (response)
			{
				if (response.statusCode == 401)
				{
					window.location.href = "{% url 'accounts:login' %}";
				}

				if (response.status_code == 200)
				{
					$('strong#qa_question_'+questionId).html(question.replace(/\n\r?/g, '<br />'));
					$('#qa_subject_'+questionId).html(subject);
					$('#qa_subject_'+questionId).attr("href", "/subject_tag/"+subject);
				}

				if (response.status_code == 404)
				{
					Swal.fire({
						icon: 'error',
						title: "Can't do that!",
						text: response.message
					});
					$( ".question_answer_container_"+questionId ).remove();
				}
			}
		});
	}

	function likeQuestionAnswer(commentId)
	{
		$.ajax(
		{
			data:
			{
				'functionality': 'likeQuestionAnswer',
				'id': commentId
			},
			dataType: 'json',
			success: function (response)
			{
				if (response.statusCode == 200)
				{
					$('#comment_like_id_'+commentId).html('<i class="far fa-thumbs-up" style="font-size:15px"></i> ('+ response.likeCount +')');
					$('#comment_dislike_id_'+commentId).html('<i class="far fa-thumbs-down" style="font-size:15px"></i> ('+ response.dislikeCount +')');
				}

				if (response.statusCode == 401)
				{
					window.location.href = "{% url 'accounts:login' %}";
				}

				if (response.statusCode == 404)
				{
					Swal.fire({
						icon: 'error',
						title: "Can't do that!",
						text: response.message
					});

					$( ".question_answer_container_"+commentId ).remove();
				}
			}
		});
	}

	function dislikeQuestionAnswer(commentId)
	{
		$.ajax(
		{
			data:
			{
				'functionality': 'dislikeQuestionAnswer',
				'id': commentId
			},
			dataType: 'json',
			success: function (response)
			{
				if (response.statusCode == 200)
				{
					$('#comment_like_id_'+commentId).html('<i class="far fa-thumbs-up" style="font-size:15px"></i> ('+ response.likeCount +')');
					$('#comment_dislike_id_'+commentId).html('<i class="far fa-thumbs-down" style="font-size:15px"></i> ('+ response.dislikeCount +')');
				}

				if (response.statusCode == 401)
				{
					window.location.href = "{% url 'accounts:login' %}";
				}

				if (response.statusCode == 404)
				{
					Swal.fire({
						icon: 'error',
						title: "Can't do that!",
						text: response.message
					});

					$( ".question_answer_container_"+commentId ).remove();
				}
			}
		});
	}

	function postQuestionAnswer()
	{
		var subject = $('#subject').find(":selected").text();
		var question = $('textarea#question').val();
		question = question.replace(/ +(?= )/g,'');
		question = question.trim();

		if (question && !question.trim() || question.length==0) {
			alert("Enter a question!");
			return;
		}

		// closing the modal and clearing the textarea
		$("#questionModal").modal('hide');
		$("textarea#question").val("");
		
		$.ajax(
		{
			data:
			{
				'functionality': 'postQuestionAnswer',
				'subject': subject,
				'question': question,
			},
			dataType: 'json',
			success: function (response)
			{
				if (response.statusCode == 401)
				{
					window.location.href = "{% url 'accounts:login' %}";
				}

				if (response.statusCode == 200)
				{
					var newQuestionAnswer = `
					<div class="container question_answer_container_`+response.id+`" style="width: auto;">
						<div id="question_answer_id_`+response.id+`">
							<a href="/subject_tag/`+subject+`" class="mtgtlDwEfX" style="display:inline-block;" id="qa_subject_`+response.id+`">`+subject+`</a>
							`+response.questionerFullName+` asked a question at
							<p style="display:inline-block;" id="tool_tip_date_`+response.id+`" data-toggle="tooltip" data-placement="top">`+response.createdDate+`</p>
							<div class="dropdown pull-right" style="display:inline-block;">
								<a class="btn-floating btn-lg black dropdown-toggle"type="button" id="dropdownMenu3" data-toggle="dropdown"
									aria-haspopup="true" aria-expanded="false"><i class="fas fa-ellipsis-v"></i></a>
								<br>
								<div class="dropdown-menu dropdown-primary">
									<span class="dropdown-item" href="#" style="cursor: pointer;" onclick="deleteQuestionAnswer('`+response.id+`');"><i class="fas fa-trash-alt"></i>&nbsp;&nbsp;Delete question</span>
									<a class="dropdown-item" href="#" data-toggle="modal" data-target="#editQuestionModal" onclick="updateEditQuestionModal('`+response.id+`');"><i class="fas fa-edit"></i>&nbsp;&nbsp;Edit question</a>
									<a class="dropdown-item" href="/question_answer_thread/`+response.id+`" target="_blank"><i class="fab fa-discourse"></i>&nbsp;&nbsp;Answer in a thread</a>
								</div>
							</div>
						</div>
						
						<div><strong id="qa_question_`+response.id+`">`+question.replace(/\n\r?/g, '<br />')+`</strong></div>
						<br>
						<div style="width: 970px;" id="qa_answer_`+response.id+`">`+response.answer.replace(/\n\r?/g, '<br />')+`</div><br>
						<button id="comment_like_id_`+response.id+`" type="button" class="btn btn-default btn-sm" onclick="likeQuestionAnswer('`+response.id+`')">
							<i class='far fa-thumbs-up' style='font-size:15px'></i> (`+response.likeCount+`)
						</button>
						<button id="comment_dislike_id_`+response.id+`" type="button" class="btn btn-default btn-sm" onclick="dislikeQuestionAnswer('`+response.id+`')">
							<i class='far fa-thumbs-down' style='font-size:15px'></i> (`+response.dislikeCount+`)
						</button><br><br>
						<span class="badge badge-info" data-toggle="modal" data-target="#answerModal" onclick="updateAnswerModal('`+response.id+`');">Answer this question</span><hr>
					</div>`;

					$( "#div-id-tutor-QuestionAnswer" ).prepend( newQuestionAnswer );
				}
			}
		});
	}

	function answerQuestionAnswer()
	{
		var answer = $('textarea#answer_text').val();
		answer = answer.trim();
		var questionId = $('#question_id').val();

		if (answer && !answer.trim() || answer.length==0)
		{
			alert("Enter an answer!");
			return;
		}

		$("#answerModal").modal('hide');

		$.ajax(
		{
			data:
			{
				'functionality': 'answerQuestionAnswer',
				'id': questionId,
				'answer': answer,
			},
			dataType: 'json',
			success: function (response)
			{

				if (response.statusCode == 401)
				{
					window.location.href = "{% url 'accounts:login' %}";
				}

				if (response.statusCode == 200)
				{
					$('div#qa_answer_'+questionId).html(answer.replace(/\n\r?/g, '<br />'));
				}

				if (response.statusCode == 404)
				{
					$( ".question_answer_container_"+questionId ).remove();
				}
			}
		});
	}

	function deleteQuestionAnswer(questionId)
	{
		$.ajax(
		{
			data:
			{
				'functionality': 'deleteQuestionAnswer',
				'id': questionId
			},
			dataType: 'json',
			success: function (response)
			{

				if (response.statusCode == 401)
				{
					window.location.href = "{% url 'accounts:login' %}";
				}


				if (response.statusCode == 200)
				{
					$( ".question_answer_container_"+questionId ).remove();
				}
			}
		});
	}

	function StartMessage() {
		$.ajax({
			data: {
				'functionality': 'start_message',
				'participant_id': '{{ tutorProfile.user.id }}',
			},
			url: '{% url "chat:startmessage" %}',
			dataType: 'json',
			success: function (response) {
				if (response.status_code == 200) {

					document.location.href = '{% url "chat:chatpage" %}';

				} else if (response.status_code == 401) {
					Swal.fire({
						icon: 'error',
						title: "Can't do that!",
						text: response.message
					});
				} else {
					Swal.fire({
						icon: 'warning',
						title: "Can't do that!",
						text: response.message
					});
				}
			}
		});
	}
</script>
{% endblock %}