{% extends "accounts/account_base.html" %}
{% load static %}
{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'css/tutoringMainpage.css' %}"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/4.9.95/css/materialdesignicons.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/js/jquery.nice-select.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/css/nice-select.min.css"/>

<div class="container">
	{% if messages %}
		{% for message in messages %}
			{% if message.tags == "error" %}
				<div style="color: black; text-align: center;" class="alert alert-danger" role="alert">{{message}}</div>
			{% else %}
				<div style="color: black; text-align: center;" class="alert alert-{{ message.tags }}" role="alert">{{message}}</div>
			{% endif %}
		{% endfor %}
	{% endif %}

	{% if showResult %}
		<br><br>
		<form>
			<div class="form-row" style="background: rgba(0, 0, 0, 0.5); padding: 43px 43px; padding-top: 40px;">
				<div class="col-11">
					<input style="border-radius: 0.5px;" type="text" class="form-control" name="subject" placeholder="Try 'GCES Maths'" value="{{ subject }}">
				</div>
				<div class="col">
					<input style="border-radius: 0.5px;" class="btn btn-primary" type="submit" value="Submit" style="background-color: #4272d7;">
				</div>
			</div>
		</form>
		<hr>
		<br>
		<div class="container">
			<div class="row align-items-center">
				<div class="col-lg-12">
					<div class="show-results mt-5">
						<div class="float-left">
							<h5 class="text-dark mb-0 pt-2">Showing {{ tutorList.start_index }}-{{ tutorList.end_index }} of {{ tutorList.paginator.count }}</h5>
						</div>
						<div class="sort-button float-right" style="color: black;">
							<ul class="list-inline mb-0">
								<li class="list-inline-item">
									<select id="sort-by-dropdown" class="nice-select" onchange="updateSortBy();">
										<option value="featured">Featured</option>
										<option value="sortPriceLH">Price: Low to High</option>
										<option value="sortPriceHL">Price: High to Low</option>
										<option value="sortScoreLH">Score: Low to High</option>
										<option value="SortScoreHL">Score: High to Low</option>
									</select>
								</li>
							</ul>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-3">
					<div class="left-sidebar" id="filterOptions">
						<div class="accordion" id="accordionExample">
							<div class="card mt-4">
								<a data-toggle="collapse" href="#collapseOne" class="job-list" aria-expanded="true" aria-controls="collapseOne">
									<div class="card-header" id="headingOne">
										<h5 class="mb-0 text-dark f-18">Features</h5>
									</div>
								</a>
								<div id="collapseOne" class="collapse show" aria-labelledby="headingOne">
									<div class="card-body p-0" id="listOfTutorFeaturesFilter">
										{% for f in tutorFeatureComponent %}
										<div class="custom-control custom-checkbox">
											<input type="checkbox" class="custom-control-input all-select" id="features-{{f.code}}" code={{f.code}} {% if f.checked %} checked {% endif %} onchange="updateFeatureFilter(this);">
											<label class="custom-control-label ml-1 text-muted f-15" for="features-{{f.code}}">{{f.internalKey}}</label>
										</div>
										{% endfor %}
									</div>
								</div>
							</div>
							<div class="card mt-4">
								<a data-toggle="collapse" href="#collapseSix" class="job-list" aria-expanded="true" aria-controls="collapseSix">
									<div class="card-header" id="headingOne">
										<h5 class="mb-0 text-dark f-18">Rating</h5>
									</div>
								</a>
								<div id="collapseSix" class="collapse show" aria-labelledby="headingOne">
									<div class="card-body p-0" id="listOfTutorRatingFilter">
										{% for e in ratingFilterComponent %}
										<div class="custom-control custom-radio">
		                                    <input type="radio" id="averageRating-{{e.code}}" name="tutorAverageRatingRadioBox" class="custom-control-input" value="{{e.code}}" {% if e.checked %} checked {% endif %} onchange="updateRatingLevel(this);">
		                                    <label class="custom-control-label ml-1 text-muted f-15" for="averageRating-{{e.code}}">{{e.internalKey|safe}}</label>
		                                </div>
										{% endfor %}
									</div>
								</div>
							</div>
							<div class="card mt-4">
								<a data-toggle="collapse" href="#collapseTwo" class="job-list" aria-expanded="true" aria-controls="collapseTwo">
									<div class="card-header" id="headingOne">
										<h5 class="mb-0 text-dark f-18">Price</h5>
									</div>
								</a>
								<div style="height: 10px;"></div>
								<div id="collapseTwo" class="collapse show" aria-labelledby="headingOne">
									<div class="card-body p-0">
										<div class="container">
											<!-- <input type="text" class="js-range-slider-price" name="my_range" value="" /> -->
											<div class="row" style="color: black;">
												<div class="col">
													<input type="number" step="0.01" class="form-control" name="minimumRate" value="{{rate.minimumRate}}" placeholder="Min">
												</div>
												<div style="padding-top: 8px;">to</div>
												<div class="col">
													<input type="number" step="0.01" class="form-control" name="maximumRate" value="{{rate.maximumRate}}" placeholder="Max">
												</div>
											</div>
										</div>
									</div>
								</div>
								<div style="height: 10px;"></div>
							</div>
							<div class="card mt-4">
								<a data-toggle="collapse" href="#collapseThree" class="job-list" aria-expanded="true" aria-controls="collapseThree">
									<div class="card-header" id="headingOne">
										<h5 class="mb-0 text-dark f-18">Tutor Score</h5>
									</div>
								</a>
								<div style="height: 10px;"></div>
								<div id="collapseThree" class="collapse show" aria-labelledby="headingOne">
									<div class="card-body p-0">
										<div class="container">
											<!-- <input type="text" class="js-range-slider-price" name="my_range" value="" /> -->
											<div class="row" style="color: black;">
												<div class="col">
													<input type="number" step="0.01" class="form-control" name="minimumScore" value="{{score.minimumScore}}" placeholder="Min">
												</div>
												<div style="padding-top: 8px;">to</div>
												<div class="col">
													<input type="number" step="0.01" class="form-control" name="maximumScore" value="{{score.maximumScore}}" placeholder="Max">
												</div>
											</div>
										</div>
									</div>
								</div>
								<div style="height: 10px;"></div>
							</div>
							<div class="card mt-4">
								<a data-toggle="collapse" href="#collapseFour" class="job-list" aria-expanded="true" aria-controls="collapseFour">
									<div class="card-header" id="headingtwo">
										<h5 class="mb-0 text-dark f-18">My Education Level</h5>
									</div>
								</a>
								<div id="collapseFour" class="collapse show" aria-labelledby="headingtwo">
									<div class="card-body p-0" id="listOfMyEducationLevelFilter">
										{% for e in myEducationLevelComponent %}
										<div class="custom-control custom-radio">
		                                    <input type="radio" id="education-{{e.code}}" name="myEducationRadioBox" class="custom-control-input" value="{{e.code}}" {% if e.checked %} checked {% endif %} onchange="updateEdcationLevel(this);">
		                                    <label class="custom-control-label ml-1 text-muted f-15" for="education-{{e.code}}">{{e.internalKey}}</label>
		                                </div>
										{% endfor %}
									</div>
								</div>
							</div>
							<div class="card mt-4">
								<a data-toggle="collapse" href="#collapseFive" class="job-list" aria-expanded="true" aria-controls="collapseFive">
									<div class="card-header" id="headingtwo">
										<h5 class="mb-0 text-dark f-18">Qualification</h5>
									</div>
								</a>
								<div id="collapseFive" class="collapse show" aria-labelledby="headingtwo">
									<div class="card-body p-0" id="listOfQualificationFilter">
										{% for q in qualificationComponent %}
										<div class="custom-control custom-checkbox">
											<input type="checkbox" class="custom-control-input all-select" id="qualification-{{q.code}}" code={{q.code}} {% if q.checked %} checked {% endif %} onchange="updateQualificationFilter(this);">
											<label class="custom-control-label ml-1 text-muted f-15" for="qualification-{{q.code}}">{{q.internalKey}}</label>
										</div>
										{% endfor %}
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-lg-9">
					<div class="candidates-listing-item" id="candidates-listing-item">
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-12">
					{% if tutorList.has_other_pages %}
						<nav aria-label="Page navigation example">
							<ul class="pagination job-pagination justify-content-center mt-5 mb-5">
								{% if tutorList.has_previous %}
								<li class="page-item">
									<a class="page-link" href="?page={{ tutorList.previous_page_number }}" aria-label="Previous">
										<span aria-hidden="true">&laquo;</span>
										<span class="sr-only">Previous</span>
									</a>
								</li>
								{% else %}
								<li class="page-item disabled">
									<a class="page-link" aria-label="Previous">
										<span aria-hidden="true">&laquo;</span>
										<span class="sr-only">Previous</span>
									</a>
								</li>
								{% endif %}

								{% for i in tutorList.paginator.page_range %}
								{% if tutorList.number == i %}
								<li class="page-item active"><span class="page-link"> {{ i }} <span class="sr-only">(current)</span></span></li>
								{% else %}
								<li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
								{% endif %}
								{% endfor %}

								{% if tutorList.has_next %}
								<li class="page-item">
									<a class="page-link" href="?page={{ tutorList.next_page_number }}" aria-label="Next">
										<span aria-hidden="true">&raquo;</span>
										<span class="sr-only">Next</span>
									</a>
								</li>
								{% else %}
								<li class="page-item disabled">
									<a class="page-link" aria-label="Next">
										<span aria-hidden="true">&raquo;</span>
										<span class="sr-only">Next</span>
									</a>
								</li>
								{% endif %}
							</ul>
						</nav>
					{% endif %}
				</div>
			</div>
		</div>
	{% else %}
		<br>
		{% if messages %}
			{% for message in messages %}
				{% if message.tags == "error" %}
					<div style="color: black; text-align: center;" class="alert alert-danger" role="alert">{{message}}</div>
				{% else %}
					<div style="color: black; text-align: center;" class="alert alert-{{ message.tags }}" role="alert">{{message}}</div>
				{% endif %}
			{% endfor %}
		{% endif %}
		<div class="s01">
			<form>
				<fieldset>
					<legend style="color: black;">Shall we find a tutor for you?</legend>
				</fieldset>
				<div class="inner-form">
					<div class="input-field first-wrap">
						<input type="text" name="subject" placeholder="Try 'GCES Maths'" />
					</div>
					<div class="input-field third-wrap">
						<button class="btn-search" type="submit">Search</button>
					</div>
				</div>
			</form>
		</div>
	{% endif %}
</div>


<script type="text/javascript">

	function profilePictureNotFound()
	{
		$('.img-class-tutor-profile-picture').attr('src','{% static "img/default-user-icon.jpg" %}');
	}

	(function ($)
	{
		$('.nice-select').niceSelect();
	}
	)(jQuery)

	window.onload = function()
	{
		// updateSortByComponent();
		renderTutorProfiles();
	};
	
	function renderTutorProfiles()
	{
		// background-color: coral;
		// background-color: coral;
		// background-color: coral;
		// background-color: coral;
		// background-color: coral;
		{% for tutor in tutorList %}

		var score = 0;
		{% for tutorLesson in tutor.tutorLessons.all %}
			score += Number('{{ tutorLesson.points }}');
		{% endfor %}

		var featureBadges = "";

		{% for feature in tutor.features.all %}
		 featureBadges += '<span class="badge badge-primary" style="background-color: {{feature.colour}};">{{feature.internalKey|upper}}</span>&nbsp;&nbsp;'
		{% endfor %}

		var tutorProfilePicture = '{{ debug }}'=='True' ? 'https://cdn3.iconfinder.com/data/icons/avatars-round-flat/33/man5-512.png' : '{{ tutor.profilePicture.url }}';

		var newComponent = `
		<div class="list-grid-item mt-4 p-2">
			<div class="row">
				<div class="col-md-9">
					<div class="candidates-img float-left mr-4">
						<img src="`+tutorProfilePicture+`" alt="" class="img-fluid d-block rounded">
					</div>
					<div class="candidates-list-desc job-single-meta  pt-2">
						<span class="mb-2 f-19">
						   <a href="{{ tutor.getTutoringUrl }}" class="text-dark" style="font-size: 23px;">{{tutor.user.get_full_name}}</a>
						   `+featureBadges+`
						</span>
						<ul class="list-inline mb-0">
							<li class="list-inline-item">
								<p class="text-muted f-15 mb-0">{{ tutor.getTutorRatingAsStars|safe }}  Earned `+score+` tutor score </p>
							</li>

							<li class="list-inline-item">
								<p class="text-muted f-15 mb-0"><i class="fas fa-chalkboard-teacher"></i> {{tutor.tutorLessons.count}} lessons taught </p>
							</li>

							<li class="list-inline-item">
								<p class="text-muted f-15 mb-0"><i class="mdi mdi-currency-gbp"></i>{{tutor.chargeRate}} / Hour</p>
							</li>
						</ul>
						<p class="text-muted" style="display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;">Summary : {{tutor.summary}}</p>
					</div>
				</div>

				<div class="col-md-3">
					<div class="candidates-list-fav-btn text-right">
						<div class="fav-icon">
							<i class="mdi mdi-heart f-20"></i>
						</div>
						<div class="candidates-listing-btn mt-4">
							<a href="{{ tutor.getTutoringUrl }}" class="btn btn-outline btn-sm">View Profile</a>
						</div>
					</div>
				</div>
			</div>

			<div class="row">
				<div class="col-lg-11 offset-lg-1">
					<div class="candidates-item-desc">
						<hr>
						<p class="text-muted mb-2 f-14" style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">About : {{tutor.about}}</p>
					</div>
				</div>
			</div>
		</div>`;

		$('#candidates-listing-item').append(newComponent);

		{% endfor %}
	}

	function updateFeatureFilter(value)
	{
		var selectedOption = [];
		$('#listOfTutorFeaturesFilter input:checked').each(function() {
		    selectedOption.push($(this).attr('code'));
		});

		var urlSplit = window.location.href.split('&');
		var alreadyExists = false;

		for (var i = 0; i < urlSplit.length; i++)
		{
			if (urlSplit[i].includes("tutorFeature="))
			{
				if (selectedOption.length==0)
				{
					urlSplit[i] = '';
				}
				else
				{
					urlSplit[i] = "tutorFeature="+selectedOption.join(",");
				}
				alreadyExists = true;
				break;
			}
		}

		urlSplit = urlSplit.join("&");

		if (!alreadyExists)
			urlSplit += "&tutorFeature="+selectedOption;
		

		if (selectedOption.length == 0)
			urlSplit = urlSplit.replace("&tutorFeature=",'');

		window.location.href = urlSplit;
	}

	function updateQualificationFilter(value)
	{
		var selectedOption = [];
		$('#listOfQualificationFilter input:checked').each(function() {
		    selectedOption.push($(this).attr('code'));
		});

		var urlSplit = window.location.href.split('&');
		var alreadyExists = false;

		for (var i = 0; i < urlSplit.length; i++)
		{
			if (urlSplit[i].includes("qualification="))
			{
				if (selectedOption.length==0)
				{
					urlSplit[i] = '';
				}
				else
				{
					urlSplit[i] = "qualification="+selectedOption.join(",");
				}
				alreadyExists = true;
				break;
			}
		}

		urlSplit = urlSplit.join("&");
		if (!alreadyExists)
			urlSplit += "&qualification="+selectedOption;

		if (selectedOption.length == 0)
			urlSplit = urlSplit.replace("&qualification=",'');

		window.location.href = urlSplit;
	}

	function updateSortBy()
	{
		updateUrlPattern($('#sort-by-dropdown').val(), "sortBy");
	}

	function updateEdcationLevel(parameter)
	{
		updateUrlPattern(parameter.value, "myEducationLevel");
	}

	function updateRatingLevel(parameter)
	{
		updateUrlPattern(parameter.value, "rating");
	}

	$("input[name='minimumRate']").on('keyup', function (e)
		{
			if (e.key === 'Enter' || e.keyCode === 13)
			{
				updateUrlPattern(this.value, "minimumRate");
			}
		}
	);

	$("input[name='maximumRate']").on('keyup', function (e)
		{
			if (e.key === 'Enter' || e.keyCode === 13)
			{
				updateUrlPattern(this.value, "maximumRate");
			}
		}
	);

	$("input[name='minimumScore']").on('keyup', function (e)
		{
			if (e.key === 'Enter' || e.keyCode === 13)
			{
				updateUrlPattern(this.value, "minimumScore");
			}
		}
	);

	$("input[name='maximumScore']").on('keyup', function (e)
		{
			if (e.key === 'Enter' || e.keyCode === 13)
			{
				updateUrlPattern(this.value, "maximumScore");
			}
		}
	);

	function updateUrlPattern(selectedArguments, urlKey)
	{
		urlKey += "="
		var urlSplit = window.location.href.split('&');
		var alreadyExists = false;

		for (var i = 0; i < urlSplit.length; i++)
		{
			if (urlSplit[i].includes(urlKey))
			{
				urlSplit[i] = urlKey+selectedArguments;
				alreadyExists = true;
			}
		}

		urlSplit = urlSplit.join("&");
		
		if (!alreadyExists)
			urlSplit += "&"+urlKey+selectedArguments;

		if(!selectedArguments)
			urlSplit = urlSplit.replace("&"+urlKey,'');

		window.location.href = urlSplit;
	}

</script>
{% endblock %}