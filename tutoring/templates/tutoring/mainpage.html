{% extends "accounts/account_base.html" %}
{% load static %}
{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'css/tutoringMainpage.css' %}"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/4.9.95/css/materialdesignicons.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/js/jquery.nice-select.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/css/nice-select.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/js/ion.rangeSlider.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/css/ion.rangeSlider.min.css"/>

<div class="container">
	{% if showResult %}
		<br><br>
		{% if messages %}
			{% for message in messages %}
				{% if message.tags == "error" %}
					<div style="color: black; text-align: center;" class="alert alert-danger" role="alert">{{message}}</div>
				{% else %}
					<div style="color: black; text-align: center;" class="alert alert-{{ message.tags }}" role="alert">{{message}}</div>
				{% endif %}
			{% endfor %}
		{% endif %}
		<form method="post">
			{% csrf_token %}
			<div class="form-row" style="background: rgba(0, 0, 0, 0.5); padding: 43px 43px; padding-top: 40px;">
				<div class="col-11">
					<input style="border-radius: 0.5px;" type="text" class="form-control" name="generalQuery" placeholder="Try 'GCES Maths'" value="{{ generalQuery }}">
				</div>
				<div class="col">
					<input style="border-radius: 0.5px;" class="btn btn-primary" type="submit" value="Submit" style="background-color: #4272d7;">
				</div>
			</div>
		</form>
		<hr>
		<br>
		<div class="container">
			<div class="row align-items-center">
				<div class="col-lg-12">
					<div class="show-results mt-5">
						<div class="float-left">
							<h5 class="text-dark mb-0 pt-2">Showing  Results : 1-6 of {{tutorList|length}}</h5>
						</div>
						<div class="sort-button float-right" style="color: black;">
							<ul class="list-inline mb-0">
								<li class="list-inline-item">
									<select class="nice-select">
										<option data-display="Sort By">Nothing</option>
										<option value="1">Web Developer</option>
										<option value="2">PHP Developer</option>
										<option value="3">Web Designer</option>
									</select>
								</li>
							</ul>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-3">
					<div class="left-sidebar" id="filterOptions">
						<div class="accordion" id="accordionExample">
							<div class="card mt-4">
								<a data-toggle="collapse" href="#collapseOne" class="job-list" aria-expanded="true" aria-controls="collapseOne">
									<div class="card-header" id="headingOne">
										<h5 class="mb-0 text-dark f-18">Features</h5>
									</div>
								</a>
								<div id="collapseOne" class="collapse show" aria-labelledby="headingOne">
									<div class="card-body p-0" id="listOfTutorFeaturesFilter">
										{% for f in tutorFeatureGroupComponent.components.all %}
										<div class="custom-control custom-checkbox">
											<input type="checkbox" class="custom-control-input all-select" id="features-{{f.code}}">
											<label class="custom-control-label ml-1 text-muted f-15" for="features-{{f.code}}">{{f}}</label>
										</div>
										{% endfor %}
									</div>
								</div>
							</div>
							<div class="card mt-4">
								<a data-toggle="collapse" href="#collapseSix" class="job-list" aria-expanded="true" aria-controls="collapseSix">
									<div class="card-header" id="headingOne">
										<h5 class="mb-0 text-dark f-18">Rating</h5>
									</div>
								</a>
								<div id="collapseSix" class="collapse show" aria-labelledby="headingOne">
									<div class="card-body p-0" id="listOfTutorRatingFilter">
										{% for e in ratingFilterComponent.components.all %}
										<div class="custom-control custom-radio">
		                                    <input type="radio" id="averageRating-{{e.reference}}" name="tutorAverageRatingRadioBox" class="custom-control-input" value="{{e.reference}}">
		                                    <label class="custom-control-label ml-1 text-muted f-15" for="averageRating-{{e.reference}}">{{e|safe}}</label>
		                                </div>
										{% endfor %}
									</div>
								</div>
							</div>
							<div class="card mt-4">
								<a data-toggle="collapse" href="#collapseTwo" class="job-list" aria-expanded="true" aria-controls="collapseTwo">
									<div class="card-header" id="headingOne">
										<h5 class="mb-0 text-dark f-18">Price</h5>
									</div>
								</a>
								<br>
								<div id="collapseTwo" class="collapse show" aria-labelledby="headingOne">
									<div class="card-body p-0">
										<div class="container">
											<input type="text" class="js-range-slider-price" name="my_range" value="" />
										</div>
									</div>
								</div>
							</div>
							<div class="card mt-4">
								<a data-toggle="collapse" href="#collapseThree" class="job-list" aria-expanded="true" aria-controls="collapseThree">
									<div class="card-header" id="headingOne">
										<h5 class="mb-0 text-dark f-18">Tutor Score</h5>
									</div>
								</a>
								<br>
								<div id="collapseThree" class="collapse show" aria-labelledby="headingOne">
									<div class="card-body p-0">
										<div class="container">
											<input type="text" class="js-range-slider-score" name="my_range" value="" />
										</div>
									</div>
								</div>
							</div>
							<div class="card mt-4">
								<a data-toggle="collapse" href="#collapseFour" class="job-list" aria-expanded="true" aria-controls="collapseFour">
									<div class="card-header" id="headingtwo">
										<h5 class="mb-0 text-dark f-18">My Education Level</h5>
									</div>
								</a>
								<div id="collapseFour" class="collapse show" aria-labelledby="headingtwo">
									<div class="card-body p-0" id="listOfEducationLevelFilter">
										{% for e in educationLevelComponent.components.all %}
										<div class="custom-control custom-radio">
		                                    <input type="radio" id="education-{{e.code}}" name="myEducationRadioBox" class="custom-control-input" value="{{e.code}}">
		                                    <label class="custom-control-label ml-1 text-muted f-15" for="education-{{e.code}}">{{e}}</label>
		                                </div>
										{% endfor %}
									</div>
								</div>
							</div>
							<div class="card mt-4">
								<a data-toggle="collapse" href="#collapseFive" class="job-list" aria-expanded="true" aria-controls="collapseFive">
									<div class="card-header" id="headingtwo">
										<h5 class="mb-0 text-dark f-18">Qualification</h5>
									</div>
								</a>
								<div id="collapseFive" class="collapse show" aria-labelledby="headingtwo">
									<div class="card-body p-0" id="listOfQualificationFilter">
										{% for q in qualificationComponent.components.all %}
										<div class="custom-control custom-checkbox">
											<input type="checkbox" class="custom-control-input all-select" id="qualification-{{q.code}}">
											<label class="custom-control-label ml-1 text-muted f-15" for="qualification-{{q.code}}">{{q}}</label>
										</div>
										{% endfor %}
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-lg-9">
					<div class="candidates-listing-item" id="candidates-listing-item">
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-12">
					{% if tutorList.has_other_pages %}
						<nav aria-label="Page navigation example">
							<ul class="pagination job-pagination justify-content-center mt-5 mb-5">
								{% if tutorList.has_previous %}
								<li class="page-item">
									<a class="page-link" href="?page={{ tutorList.previous_page_number }}" aria-label="Previous">
										<span aria-hidden="true">&laquo;</span>
										<span class="sr-only">Previous</span>
									</a>
								</li>
								{% else %}
								<li class="page-item disabled">
									<a class="page-link" aria-label="Previous">
										<span aria-hidden="true">&laquo;</span>
										<span class="sr-only">Previous</span>
									</a>
								</li>
								{% endif %}

								{% for i in tutorList.paginator.page_range %}
								{% if tutorList.number == i %}
								<li class="page-item active"><span class="page-link"> {{ i }} <span class="sr-only">(current)</span></span></li>
								{% else %}
								<li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
								{% endif %}
								{% endfor %}

								{% if tutorList.has_next %}
								<li class="page-item">
									<a class="page-link" href="?page={{ tutorList.next_page_number }}" aria-label="Next">
										<span aria-hidden="true">&raquo;</span>
										<span class="sr-only">Next</span>
									</a>
								</li>
								{% else %}
								<li class="page-item disabled">
									<a class="page-link" aria-label="Next">
										<span aria-hidden="true">&raquo;</span>
										<span class="sr-only">Next</span>
									</a>
								</li>
								{% endif %}
							</ul>
						</nav>
					{% endif %}
				</div>
			</div>
		</div>
	{% else %}
		<br>
		{% if messages %}
			{% for message in messages %}
				{% if message.tags == "error" %}
					<div style="color: black; text-align: center;" class="alert alert-danger" role="alert">{{message}}</div>
				{% else %}
					<div style="color: black; text-align: center;" class="alert alert-{{ message.tags }}" role="alert">{{message}}</div>
				{% endif %}
			{% endfor %}
		{% endif %}
		<div class="s01">
			<form method="post">
				{% csrf_token %}
				<fieldset>
					<legend style="color: black;">Shall we find a tutor for you?</legend>
				</fieldset>
				<div class="inner-form">
					<div class="input-field first-wrap">
						<input type="text" name="generalQuery" placeholder="Try 'GCES Maths'" />
					</div>
					<div class="input-field third-wrap">
						<button class="btn-search" type="submit">Search</button>
					</div>
				</div>
			</form>
		</div>
	{% endif %}
</div>
<script type="text/javascript">

	var PRICE_FROM = {{defaultPriceValues.priceFrom}};
	var PRICE_TO = {{defaultPriceValues.priceTo}};

	var TUTOR_SCORE_FROM = {{defaultScoreValues.scoreFrom}};
	var TUTOR_SCORE_TO = {{defaultScoreValues.scoreTo}};


	function profilePictureNotFound()
	{
		$('.img-class-tutor-profile-picture').attr('src','{% static "img/default-user-icon.jpg" %}');
	}

	(function ($)
	{
		$('.nice-select').niceSelect();
	}
	)(jQuery)

	window.onload = function()
	{
		updateFilterComponent();
		renderTutorProfiles();
	};

	function updateFilterComponent()
	{
		var listOfTickedFeatures = eval("{{tickedTutorFeature|safe}}");
		for (const feature of listOfTickedFeatures)
		{
			$('#features-'+feature).prop('checked', true);
		}

		$('#education-{{selectedEducationLevel}}').prop('checked', true);
		$('#averageRating-{{selectedAverageRating}}').prop('checked', true);
	}

	function renderTutorProfiles()
	{
		// background-color: coral;
		// background-color: coral;
		// background-color: coral;
		// background-color: coral;
		// background-color: coral;
		{% for tutor in tutorList %}

		var score = 0;
		{% for tutorLesson in tutor.tutorLessons.all %}
			score += Number('{{ tutorLesson.points }}');
		{% endfor %}

		var featureBadges = "";

		{% for feature in tutor.features.all %}
		 featureBadges += '<span class="badge badge-primary" style="background-color: {{feature.colour}};">{{feature.internalKey|upper}}</span>&nbsp;&nbsp;'
		{% endfor %}

		var newComponent = `
		<div class="list-grid-item mt-4 p-2">
			<div class="row">
				<div class="col-md-9">
					<div class="candidates-img float-left mr-4">
						<img src="{{ tutor.profilePicture.url }}" alt="" class="img-fluid d-block rounded">
					</div>
					<div class="candidates-list-desc job-single-meta  pt-2">
						<span class="mb-2 f-19">
						   <a href="{{ tutor.getTutoringUrl }}" class="text-dark" style="font-size: 23px;">{{tutor.user.get_full_name}}</a>
						   `+featureBadges+`
						</span>
						<ul class="list-inline mb-0">
							<li class="list-inline-item">
								<p class="text-muted f-15 mb-0">{{ tutor.getTutorRatingAsStars|safe }}  Earned `+score+` tutor score </p>
							</li>

							<li class="list-inline-item">
								<p class="text-muted f-15 mb-0"><i class="fas fa-chalkboard-teacher"></i> {{tutor.tutorLessons.count}} lessons taught </p>
							</li>

							<li class="list-inline-item">
								<p class="text-muted f-15 mb-0"><i class="mdi mdi-currency-gbp"></i>{{tutor.chargeRate}} / Hour</p>
							</li>
						</ul>
						<p class="text-muted" style="display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;">Summary : {{tutor.summary}}</p>
					</div>
				</div>

				<div class="col-md-3">
					<div class="candidates-list-fav-btn text-right">
						<div class="fav-icon">
							<i class="mdi mdi-heart f-20"></i>
						</div>
						<div class="candidates-listing-btn mt-4">
							<a href="{{ tutor.getTutoringUrl }}" class="btn btn-outline btn-sm">View Profile</a>
						</div>
					</div>
				</div>
			</div>

			<div class="row">
				<div class="col-lg-11 offset-lg-1">
					<div class="candidates-item-desc">
						<hr>
						<p class="text-muted mb-2 f-14" style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">About : {{tutor.about}}</p>
					</div>
				</div>
			</div>
		</div>`;

		$('#candidates-listing-item').append(newComponent);

		{% endfor %}
	}

	$(".js-range-slider-price").ionRangeSlider(
		{
			type: "double",
			min: 0,
			max: 100,
			from: {{defaultPriceValues.priceFrom}},
			to: {{defaultPriceValues.priceTo}},
			max_postfix: "+",
			prefix: "£",
			grid: true,

			onStart: function (data)
			{
				// Called right after range slider instance initialised
		
				// console.log(data.input);        // jQuery-link to input
				// console.log(data.slider);       // jQuery-link to range sliders container
				// console.log(data.min);          // MIN value
				// console.log(data.max);          // MAX values
				// console.log(data.from);         // FROM value
				// console.log(data.from_percent); // FROM value in percent
				// console.log(data.from_value);   // FROM index in values array (if used)
				// console.log(data.to);           // TO value
				// console.log(data.to_percent);   // TO value in percent
				// console.log(data.to_value);     // TO index in values array (if used)
				// console.log(data.min_pretty);   // MIN prettified (if used)
				// console.log(data.max_pretty);   // MAX prettified (if used)
				// console.log(data.from_pretty);  // FROM prettified (if used)
				// console.log(data.to_pretty);    // TO prettified (if used)
			},
	
			onChange: function (data)
			{
				// Called every time handle position is changed
				PRICE_FROM = data.from;
				PRICE_TO = data.to;
			},
	
			onFinish: function (data)
			{
				// Called then action is done and mouse is released                
			},
	
			onUpdate: function (data)
			{
				// Called then slider is changed using Update public method
			}
		}
	);

	$(".js-range-slider-score").ionRangeSlider(
		{
			type: "double",
			min: 0,
			max: 2000,
			from: {{defaultScoreValues.scoreFrom}},
			to: {{defaultScoreValues.scoreTo}},
			max_postfix: "+",
			prefix: "Score: ",
			grid: true,

			onStart: function (data)
			{
				// Called right after range slider instance initialised
			},
	
			onChange: function (data)
			{
				// Called every time handle position is changed
				TUTOR_SCORE_FROM = data.from;
				TUTOR_SCORE_TO = data.to;
			},
	
			onFinish: function (data)
			{
				// Called then action is done and mouse is released                
			},
	
			onUpdate: function (data)
			{
				// Called then slider is changed using Update public method
			}
		}
	);

   let featureCheckBoxes = eval("{{tutorFeatureGroupComponent.getRelatedFeatureComponentByOrderNoForId|safe}}");

   $('#filterOptions').change(
		function()
		{
			var searchQuery = "";

			var featureStringAdded = false;
			for (const checks of featureCheckBoxes)
			{            
				if($('#' + checks).is(":checked"))
				{
					if (!featureStringAdded)
					{
						searchQuery += "tutorFeature:"
						featureStringAdded = true;
					}

					var featureCode = checks.split("-")[1];
					searchQuery +=featureCode + ",";
				}
			}

			searchQuery = searchQuery.substring(0, searchQuery.length - 1);

			var priceAdded = false;
			if (PRICE_FROM > 0 || PRICE_TO < 100)
			{
				if(!priceAdded)
				{
					if (searchQuery.length != 0)
					{
						searchQuery += "&";
					}

					searchQuery += "hourlyPrice:";
					priceAdded = true;
				}
				searchQuery += PRICE_FROM + "," + PRICE_TO;
			}

			var scoreAdded = false;

			if (TUTOR_SCORE_FROM > 0 || TUTOR_SCORE_TO < 100)
			{
				if(!scoreAdded)
				{
					if (searchQuery.length != 0)
					{
						searchQuery += "&";
					}
					searchQuery += "tutorScore:";
					scoreAdded = true;
				}
				searchQuery += TUTOR_SCORE_FROM + "," + TUTOR_SCORE_TO;
			}

			var myEducationRadioBox = $('input[name="myEducationRadioBox"]:checked').val();
			if (myEducationRadioBox)
			{
				if(searchQuery)
				{
					searchQuery += "&";
				}
				
				searchQuery += "myEducationLevel:";
				searchQuery += myEducationRadioBox;
			}

			var tutorAverageRatingRadioBox = $('input[name="tutorAverageRatingRadioBox"]:checked').val();
			if (tutorAverageRatingRadioBox && tutorAverageRatingRadioBox > -1)
			{
				if(searchQuery)
				{
					searchQuery += "&";
				}
				searchQuery += "tutorAverageRating:";
				searchQuery += tutorAverageRatingRadioBox;
			}

			// if (!searchQuery)
			// 	return;
			
			var newFilters = "{{ generalQuery }}/" + searchQuery;
			window.location.href = "{% url 'tutoring:searchBySubjectAndFilter' searchParameters='data' %}".replace("data", newFilters);
		}
	);
</script>
{% endblock %}