{% extends "accounts/account_base.html" %}
{% load static %}
{% block content %}
<style type="text/css">
	@media (min-width: 1200px) {
		.container {
			width: 1600px;
		}
		.wrapper {
			width: 80%;
		}
	}

	@media (min-width: 972px) and (max-width: 1200px) {
		.container {
			width: 1600px;
		}
		.wrapper {
			width: 90%;
		}
	}

	@media (min-width: 700px) and (max-width: 959px) {
		.container {
			width: 1600px;
		}
		.wrapper {
			width: 90%;
		}
		
	}

	.tickets {
		background-color: #f1f1f1;
		border: 1px solid #d3d3d3;
		width: 100%;
	}

	.card {
	    position: relative;
	    display: flex;
	    flex-direction: column;
	    min-width: 0;
	    word-wrap: break-word;
	    background-color: #fff;
	    background-clip: border-box;
	    border: 0 solid transparent;
	    border-radius: 0;
	}

	ul { list-style-type: none; margin: 0; padding: 0; margin-bottom: 10px; }
</style>
<div class="col-xs-12" style="height:10px;"></div>
<button id="ticketModalButton" data-toggle="modal" data-target=".bd-example-modal-lg" hidden></button>
<div id="ticket_description_modal" class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="#myLargeModalLabel" aria-hidden="true" style="color:black;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                	<span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
            	<div class="row">
            		<div class="col-8">
            			<input class="form-control form-control-lg" type="text" placeholder="Ticket title" id="ticketTitleInModel">
            			<br>
            			<strong>Description</strong>
            			<br>
            			<textarea cols="60" rows="5" id="ticketDescriptionInModal" class="form-control" oninput="auto_grow(this)"></textarea>
            			<div id="changeMade" value="false" hidden></div>
            			<div id="ticketId" hidden></div>
            			<div id="ticketUrl" hidden></div>
            		</div>
            		<div class="col-4">
            			<p style="color: rgb(117, 117, 117); margin: 0px;">Assignees</p>
            			<div style="display: flex; -webkit-box-align: center; align-items: center; margin: 0.5rem 0px; overflow-wrap: anywhere;">
            				<div>
            					<div style="height: 2rem; width: 2rem; margin-right: 0.5rem;">
            						<img alt="shark" src="https://knboard.com/media/avatars/shark.png" style="color: transparent; width: 100%; height: 100%; object-fit: cover; text-align: center; text-indent: 10000px">
            					</div>
            				</div>
            				<div>User--</div>
            			</div>
            			<br>
            			<small>Column</small>
            			<select class="form-control" id="ticketStatusInModal">
            				
            			</select>
            			<small>Priority</small>
            			<select class="form-control" id="ticketPriorityInModal">

            			</select>
            			<small>Issue Type</small>
            			<select class="form-control" id="ticketIssueTypeInModal">
            				
            			</select>
            			<small>Labels</small>
            			<select class="form-control">
            				<option>1</option> <option>2</option> <option>3</option> <option>4</option> <option>5</option>
            			</select>
            			<br>
            			<button type="button" class="btn btn-danger"><i class='fa fa-trash-o' style='font-size:20px'></i> Delete Ticket</button>
            			<br><br>
            			<button type="button" class="btn btn-success" onclick="updateTicketAttributesFromModal();"><i class='fa fa-check' style='font-size:20px'></i> Update Ticket</button>
            		</div>
            	</div>
            </div>
        </div>
    </div>
</div>
<div class="wrapper" style="margin: auto;overflow-x: hidden;">
    <br>
    <div class="row gutters-sm">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body tab-content" style="color: black;">
                	<h3>One Tutor ({{activeSprint.startDate}} - {{activeSprint.endDate}})</h3>
                	<hr>
                	<div class="row">
                		<div class="col">
                			<div class="row">TO DO</div>
                			<ul class="tickets connectedSortable" id="openTickets">

                			</ul>
                		</div>
                		<div class="col">
                			<div class="row">IN PROGRESS</div>
                			<ul class="tickets connectedSortable" id="progressTickets">

                			</ul>
                		</div>
                		<div class="col">
                			<div class="row">DONE</div>
                			<ul class="tickets connectedSortable" id="doneAndCancelledTickets">

                			</ul>
                		</div>
                	</div>
                </div>
            </div>
        </div>
    </div>
    <br>
</div>
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script type="text/javascript">

	var sprintTickets = [];

	parseTickets();
	renderTickets();

	function parseTickets()
	{
		{% for ticket in sprintTickets %}
			sprintTickets.push({
				"id": '{{ticket.id}}',
				"url": '{{ticket.url|linebreaksbr}}',
				"issueType": '{{ticket.issueType}}',
				"summary": '{{ticket.summary|linebreaksbr}}',
				"description": '{{ticket.description|linebreaksbr}}',
				"points": '{{ticket.points}}',
				"status": '{{ticket.status}}',
				"priority": '{{ticket.priority}}',
			});
		{% endfor %}
	}

	function renderTickets()
	{
		$( "#openTickets" ).empty();
		$( "#progressTickets" ).empty();
		$( "#doneAndCancelledTickets" ).empty();

		for (const ticket of sprintTickets)
		{
			if (ticket.status == 'Open')
			{
				$("#openTickets").append(ticketComponent(ticket));
			}
			else if (ticket.status == 'Progress')
			{
				$("#progressTickets").append(ticketComponent(ticket));
			}
			else if (ticket.status == 'Done' || ticket.status == 'Cancelled')
			{
				$("#doneAndCancelledTickets").append(ticketComponent(ticket));
			}
		}
	}

	$( function()
	{
		$( "#openTickets, #progressTickets, #doneAndCancelledTickets" ).sortable(
		{
			// revert: true
			connectWith: ".connectedSortable"
		}).disableSelection();

		$( "#draggable" ).draggable(
		{
			connectToSortable: "#sortable",
			helper: "clone",
			revert: "invalid"
		});

		$( "ul, li" ).disableSelection();
	});

	$("#openTickets").on('DOMNodeInserted', function(e)
	{
		// ticket moved to: TO DO
		var anchorElement = e.target.querySelector('a');

		if (anchorElement != null)
		{
			var ticketUrl = anchorElement.innerHTML;

			$.ajax({
				data: {
					'functionality': 'moveTicketToOpen',
					'ticketUrl': ticketUrl,
				},
				dataType: 'json',
			});
		}
	});

	$("#progressTickets").on('DOMNodeInserted', function(e)
	{
		// ticket moved to: IN PROGRESS
		var anchorElement = e.target.querySelector('a');

		if (anchorElement != null)
		{
			var ticketUrl = anchorElement.innerHTML;

			$.ajax({
				data: {
					'functionality': 'moveTicketToProgress',
					'ticketUrl': ticketUrl,
				},
				dataType: 'json',
			});
		}
	});

	$("#doneAndCancelledTickets").on('DOMNodeInserted', function(e)
	{
		// ticket moved to: IN DONE
		var anchorElement = e.target.querySelector('a');

		if (anchorElement != null)
		{
			var ticketUrl = anchorElement.innerHTML;

			$.ajax({
				data: {
					'functionality': 'moveTicketToDone',
					'ticketUrl': ticketUrl,
				},
				dataType: 'json',
			});
		}
	});

	window.onclick = e => {
        openTicketModalDescription(e.target);
    }

    function openTicketModalDescription(e)
    {
    	try {

            if (e.hasAttribute("isTicket") && e.hasAttribute("ticketId") && e.hasAttribute("ticketUrl"))
            {
            	var lookUpTicket = null;
            	
            	var ticketId = e.getAttribute("ticketId");
            	var ticketUrl = e.getAttribute("ticketUrl");            	

            	for (const ticket of sprintTickets)
				{
					if (ticket.id == ticketId && ticket.url == ticketUrl)
					{
						lookUpTicket = ticket;
						break;
					}
				}

				if (lookUpTicket == null)
					return;

				// update the modal so that the clicked ticket details can be shown to the user.
				$('#ticketTitleInModel').val(lookUpTicket.summary);
				$('#ticketDescriptionInModal').val(lookUpTicket.description);
				$('#ticketStatusInModal').append(getTicketStatusDropdownSelected(lookUpTicket.status));
				$('#ticketPriorityInModal').append(getTicketPriorityDropdownSelected(lookUpTicket.priority));
				$('#ticketIssueTypeInModal').append(getTicketIssueTypeDropdownSelected(lookUpTicket.issueType));
				$('#ticketId').val(lookUpTicket.id);
				$('#ticketUrl').val(lookUpTicket.url);
				$("#changeMade").attr("value","false");

            	// temporary way to open the modal.
                document.getElementById("ticketModalButton").click();
            }

            return openTicketModalDescription(e.parentElement);

        }
        catch(err)
        {
            return;
        }
    	
    }

    function getTicketIssueTypeDropdownSelected(issue)
    {
    	$('#ticketIssueTypeInModal').children().remove().end();

    	var value = '';

    	value += issue=='Bug' ? '<option selected >Bug</option>' : '<option>Bug</option>';
        value += issue=='Improvement' ? '<option selected >Improvement</option>' : '<option>Improvement</option>';
        value += issue=='Story' ? '<option selected >Story</option>' : '<option>Story</option>';
        value += issue=='Task' ? '<option selected >Task</option>' : '<option>Task</option>';
        value += issue=='Test' ? '<option selected >Test</option>' : '<option>Test</option>';
        value += issue=='Epic' ? '<option selected >Epic</option>' : '<option>Epic</option>';

    	return value;
    }

    function getTicketStatusDropdownSelected(status)
    {
    	$('#ticketStatusInModal').children().remove().end();

    	var value = '';

    	value += status=='Open' ? '<option selected value="Open">To Do</option>' : '<option value="Open">To Do</option>';
        value += status=='Progress' ? '<option selected value="Progress">In progress</option>' : '<option value="Progress">In progress</option>';
        value += status=='Done' ? '<option selected value="Done">Done</option>' : '<option value="Done">Done</option>';
        value += status=='Cancelled' ? '<option selected value="Cancelled">Cancelled</option>' : '<option value="Cancelled">Cancelled</option>';

    	return value;
    }

    function getTicketPriorityDropdownSelected(priority)
    {
    	$('#ticketPriorityInModal').children().remove().end();

    	var value = '';

    	value += priority=='Low' ? '<option selected >Low</option>' : '<option>Low</option>';
        value += priority=='Medium' ? '<option selected >Medium</option>' : '<option>Medium</option>';
        value += priority=='High' ? '<option selected>High</option>' : '<option>High</option>';
        value += priority=='None' ? '<option selected>None</option>' : '<option>None</option>';

    	return value;
    }

    function auto_grow(element)
    {
    	element.style.height = "5px";
    	element.style.height = (element.scrollHeight)+"px";
    }

    function updateTicketAttributesFromModal()
    {
    	var isChanged = eval($("#changeMade").attr('value'));
    	var newSummary = $('#ticketTitleInModel').val();
    	var newDescription = $('#ticketDescriptionInModal').val();
    	var newStatus = $('#ticketStatusInModal').val();
    	var newPriority = $("#ticketPriorityInModal").val();
    	var newIssueType = $("#ticketIssueTypeInModal").val();
    	var thisTicketId = $("#ticketId").val();
    	var thisTicketUrl = $("#ticketUrl").val();

    	// TODO: need to update Labels in the database if changed in the UI.

    	if (isChanged)
    	{
    		$.ajax({
				data: {
					'functionality': 'updateTicketAttributesFromModal',
					'newSummary': newSummary,
					'newDescription': newDescription,
					'newIssueType': newIssueType,
					'newStatus': newStatus,
					'newPriority': newPriority,
					'ticketUrl': thisTicketUrl,
				},
				dataType: 'json',
				success: function (response)
				{
					if (response.statusCode == 200)
					{
						for (const ticket of sprintTickets)
						{
							if (ticket.id == thisTicketId && ticket.url == thisTicketUrl)
							{
								ticket.summary = newSummary;
								ticket.description = newDescription;
								ticket.issueType = newIssueType;
								ticket.status = newStatus;
								ticket.priority = newPriority;
								// ticket.points = newPoints;
								break;
							}
						}

						// $("#openTickets").off('DOMNodeInserted');
						// $("#progressTickets").off('DOMNodeInserted');
						// $("#doneAndCancelledTickets").off('DOMNodeInserted');
						renderTickets();
						// $("#openTickets").on('DOMNodeInserted');
						// $("#progressTickets").on('DOMNodeInserted');
						// $("#doneAndCancelledTickets").on('DOMNodeInserted');
					}
				}
			});

    	}
    	$("#changeMade").attr("value","false");
    }

    function updateTIcketNewColumnInUI(ticket_code, new_column) {
    	// TODO: remove this method after git annotate check.

    	var ticket_div = document.getElementById('jira_ticket_'+ticket_code+'_in_board');

    	if (new_column == 'Open')
    		$('#openTickets').append(ticket_div);

    	if (new_column == 'Progress')
    		$('#progressTickets').append(ticket_div);

    	if (new_column == 'Done' || new_column == 'Cancelled')
    		$('#doneAndCancelledTickets').append(ticket_div);

    	return;
    }

    function updateTicketNewPriorityBadgeInUI(ticket_code, new_priority) {
    	// TODO: remove this method after git annotate check.
    	var new_class = 'badge ';

    	if (new_priority == 'None') {
    		new_class+= 'badge-secondary';
    	}
    	else if (new_priority == 'Low') {
    		new_class+= 'badge-success';
    	}
    	else if (new_priority == 'Medium') {
    		new_class+= 'badge-warning';
    	}
    	else if (new_priority == 'High') {
    		new_class+= 'badge-danger';
    	}

    	$('#ticket_'+ticket_code+'_priority_UI_badge').attr("class", new_class).text(new_priority);
    }

    document.getElementById('ticketTitleInModel').addEventListener('input', function () {
    	 $("#changeMade").attr("value","true");
    });

    document.getElementById('ticketDescriptionInModal').addEventListener('input', function () {
    	 $("#changeMade").attr("value","true");
    });

    $("#ticketStatusInModal, #ticketPriorityInModal, #ticketIssueTypeInModal").on('change', function() {
    	if ($(this).val() != 'selectionKey'){
    		$("#changeMade").attr("value","true");
    	}
    });


    function ticketComponent(ticket)
    {
    	var ticketPriorityBadge = null;

    	if (ticket.priority == "Low")
    	{
    		ticketPriorityBadge = `<span class="badge badge-success">`+ ticket.priority +`</span>`;
    	}
    	else if (ticket.priority == "Medium")
    	{
    		ticketPriorityBadge = `<span class="badge badge-warning">`+ ticket.priority +`</span>`;
    	}
    	else if (ticket.priority == "High")
    	{
    		ticketPriorityBadge = `<span class="badge badge-danger">`+ ticket.priority +`</span>`;
    	}
    	else
    	{
    		ticketPriorityBadge = `<span class="badge badge-secondary">`+ ticket.priority +`</span>`;
    	}

    	var ticketPageUrl = "{% url 'jira:ticketpage' ticket_url='ticketurl' %}".replace("ticketurl", ticket.url);

    	var newTicketComponent = `
    	<li isTicket="true" ticketId=`+ ticket.id +` ticketUrl=`+ ticket.url +` class="single-note-item all-category shadow p-3 mb-2 bg-white rounded" style="width: 100%; cursor: move;" draggable="true">
	        <div class="card card-body">
	        	<a id="ticket_url" href="`+ticketPageUrl+`" style="color: grey;">`+ ticket.url +`</a>
	            <h6 class="note-title text-truncate w-75 mb-0">`+ ticket.summary +`</h6>
	            <br>
	            <div>
	            	<img src='{% static "img/" %}`+ ticket.issueType.toLowerCase() +`.jpg' width="20" height="20" data-toggle="tooltip" data-placement="top" title="{{ticket.issueType}}">

	            	` + ticketPriorityBadge + `

					<span class="badge badge-pill badge-secondary">`+ ticket.points +`</span>
	            </div>
	        </div>
	    </li>`;

	    return newTicketComponent;
    }

</script>
{% endblock %}